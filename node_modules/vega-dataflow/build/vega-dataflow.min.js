!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("vega-util"),require("vega-loader"),require("vega-format")):"function"==typeof define&&define.amd?define(["exports","vega-util","vega-loader","vega-format"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).vega={},t.vega,t.vega,t.vega)}(this,(function(t,e,n,r){"use strict";function s(t){const n=t||e.identity,r=[],s={};return r.add=t=>{const e=n(t);return s[e]||(s[e]=1,r.push(t)),r},r.remove=t=>{const e=n(t);if(s[e]){s[e]=0;const n=r.indexOf(t);n>=0&&r.splice(n,1)}return r},r}async function i(t,e){try{await e(t)}catch(e){t.error(e)}}const o=Symbol("vega_id");let a=1;function u(t){return t[o]}function l(t,e){return t[o]=e,t}function h(t){const e=t===Object(t)?t:{data:t};return u(e)?e:l(e,a++)}function c(t,e){for(const n in t)e[n]=t[n];return e}function d(t){return t&&t.constructor===f}function f(){let t=[],n=[],r=[],s=[],i=[],o=null,a=!1;return{constructor:f,insert(n){let r=e.array(n),s=0,i=r.length;for(;s<i;++s)t.push(r[s]);return this},remove(t){let r=e.isFunction(t)?s:n,i=e.array(t),o=0,a=i.length;for(;o<a;++o)r.push(i[o]);return this},modify(t,n,s){let o={field:n,value:e.constant(s)};return e.isFunction(t)?(o.filter=t,i.push(o)):(o.tuple=t,r.push(o)),this},encode(t,n){return e.isFunction(t)?i.push({filter:t,field:n}):r.push({tuple:t,field:n}),this},clean(t){return o=t,this},reflow(){return a=!0,this},pulse(e,l){let c,d,f,p,g,m,_={},v={};for(c=0,d=l.length;c<d;++c)_[u(l[c])]=1;for(c=0,d=n.length;c<d;++c)g=n[c],_[u(g)]=-1;for(c=0,d=s.length;c<d;++c)p=s[c],l.forEach(t=>{p(t)&&(_[u(t)]=-1)});for(c=0,d=t.length;c<d;++c)g=t[c],m=u(g),_[m]?_[m]=1:e.add.push(h(t[c]));for(c=0,d=l.length;c<d;++c)g=l[c],_[u(g)]<0&&e.rem.push(g);function y(t,n,r){r?t[n]=r(t):e.encode=n,a||(v[u(t)]=t)}for(c=0,d=r.length;c<d;++c)f=r[c],g=f.tuple,p=f.field,m=_[u(g)],m>0&&(y(g,p,f.value),e.modifies(p));for(c=0,d=i.length;c<d;++c)f=i[c],p=f.filter,l.forEach(t=>{p(t)&&_[u(t)]>0&&y(t,f.field,f.value)}),e.modifies(f.field);if(a)e.mod=n.length||s.length?l.filter(t=>_[u(t)]>0):l.slice();else for(m in v)e.mod.push(v[m]);return(o||null==o&&(n.length||s.length))&&e.clean(!0),e}}}function p(){Object.defineProperty(this,"_:mod:_",{writable:!0,value:{}})}p.prototype={set(t,n,r,s){const i=this,o=i[t],a=i["_:mod:_"];return null!=n&&n>=0?(o[n]!==r||s)&&(o[n]=r,a[n+":"+t]=-1,a[t]=-1):(o!==r||s)&&(i[t]=r,a[t]=e.isArray(r)?1+r.length:-1),i},modified(t,n){let r,s=this["_:mod:_"];if(!arguments.length){for(r in s)if(s[r])return!0;return!1}if(e.isArray(t)){for(r=0;r<t.length;++r)if(s[t[r]])return!0;return!1}return null!=n&&n>=0?n+1<s[t]||!!s[n+":"+t]:!!s[t]},clear(){return this["_:mod:_"]={},this}};let g=0;const m=new p;function _(t,e,n,r){this.id=++g,this.value=t,this.stamp=-1,this.rank=-1,this.qrank=-1,this.flags=0,e&&(this._update=e),n&&this.parameters(n,r)}function v(t){return function(e){const n=this.flags;return 0===arguments.length?!!(n&t):(this.flags=e?n|t:n&~t,this)}}_.prototype={targets(){return this._targets||(this._targets=s(e.id))},set(t){return this.value!==t?(this.value=t,1):0},skip:v(1),modified:v(2),parameters(t,n,r){n=!1!==n;let s,i,o,a,u=this._argval=this._argval||new p,l=this._argops=this._argops||[],h=[];const c=(t,e,r)=>{r instanceof _?(r!==this&&(n&&r.targets().add(this),h.push(r)),l.push({op:r,name:t,index:e})):u.set(t,e,r)};for(s in t)if(i=t[s],"pulse"===s)e.array(i).forEach(t=>{t instanceof _?t!==this&&(t.targets().add(this),h.push(t)):e.error("Pulse parameters must be operator instances.")}),this.source=i;else if(e.isArray(i))for(u.set(s,-1,Array(o=i.length)),a=0;a<o;++a)c(s,a,i[a]);else c(s,-1,i);return this.marshall().clear(),r&&(l.initonly=!0),h},marshall(t){let e,n,r,s,i,o=this._argval||m,a=this._argops;if(a){for(n=0,r=a.length;n<r;++n)e=a[n],s=e.op,i=s.modified()&&s.stamp===t,o.set(e.name,e.index,s.value,i);if(a.initonly){for(n=0;n<r;++n)e=a[n],e.op.targets().remove(this);this._argops=null,this._update=null}}return o},detach(){let t,e,n,r,s=this._argops;if(s)for(t=0,e=s.length;t<e;++t)n=s[t],r=n.op,r._targets&&r._targets.remove(this)},evaluate(t){const e=this._update;if(e){const n=this.marshall(t.stamp),r=e.call(this,n,t);if(n.clear(),r!==this.value)this.value=r;else if(!this.modified())return t.StopPropagation}},run(t){if(t.stamp<this.stamp)return t.StopPropagation;let e;return this.skip()?(this.skip(!1),e=0):e=this.evaluate(t),this.pulse=e||t}};let y=0;function k(t,e,n){this.id=++y,this.value=null,n&&(this.receive=n),t&&(this._filter=t),e&&(this._apply=e)}function w(t,e,n){return new k(t,e,n)}k.prototype={_filter:e.truthy,_apply:e.identity,targets(){return this._targets||(this._targets=s(e.id))},consume(t){return arguments.length?(this._consume=!!t,this):!!this._consume},receive(t){if(this._filter(t)){let e=this.value=this._apply(t),n=this._targets,r=n?n.length:0,s=0;for(;s<r;++s)n[s].receive(e);this._consume&&(t.preventDefault(),t.stopPropagation())}},filter(t){const e=w(t);return this.targets().add(e),e},apply(t){const e=w(null,t);return this.targets().add(e),e},merge(){const t=w();this.targets().add(t);for(let e=0,n=arguments.length;e<n;++e)arguments[e].targets().add(t);return t},throttle(t){let e=-1;return this.filter(()=>{const n=Date.now();return n-e>t?(e=n,1):0})},debounce(t){const n=w();return this.targets().add(w(null,null,e.debounce(t,t=>{const e=t.dataflow;n.receive(t),e&&e.run&&e.run()}))),n},between(t,e){let n=!1;return t.targets().add(w(null,null,()=>n=!0)),e.targets().add(w(null,null,()=>n=!1)),this.filter(()=>n)},detach(){}};const F={skip:!0};function A(t,n,r,s,i,o){let a,u,l=e.extend({},o,F);e.isFunction(r)||(r=e.constant(r)),void 0===s?a=e=>t.touch(r(e)):e.isFunction(s)?(u=new _(null,s,i,!1),a=e=>{u.evaluate(e);const n=r(e),s=u.value;d(s)?t.pulse(n,s,o):t.update(n,s,l)}):a=e=>t.update(r(e),s,l),n.apply(a)}function D(t,n,r,s,i,o){if(void 0===s)n.targets().add(r);else{const a=o||{},u=new _(null,function(t,n){return n=e.isFunction(n)?n:e.constant(n),t?function(e,r){const s=n(e,r);return t.skip()||(t.skip(s!==this.value).value=s),s}:n}(r,s),i,!1);u.modified(a.force),u.rank=n.rank,n.targets().add(u),r&&(u.skip(!0),u.value=r.value,u.targets().add(r),t.connect(r,[u]))}}const E={};function P(t,e,n){this.dataflow=t,this.stamp=null==e?-1:e,this.add=[],this.rem=[],this.mod=[],this.fields=null,this.encode=n||null}function b(t,n){const r=[];return e.visitArray(t,n,t=>r.push(t)),r}function q(t,e){const n={};return t.visit(e,(function(t){n[u(t)]=1})),t=>n[u(t)]?null:t}function O(t,e){return t?(n,r)=>t(n,r)&&e(n,r):e}function M(t,e,n,r){let s,i,o,a,u,l=this,h=0;for(this.dataflow=t,this.stamp=e,this.fields=null,this.encode=r||null,this.pulses=n,o=0,a=n.length;o<a;++o)if(s=n[o],s.stamp===e){if(s.fields)for(u in i=l.fields||(l.fields={}),s.fields)i[u]=1;s.changed(l.ADD)&&(h|=l.ADD),s.changed(l.REM)&&(h|=l.REM),s.changed(l.MOD)&&(h|=l.MOD)}this.changes=h}function S(t){return t.error("Dataflow already running. Use runAsync() to chain invocations."),t}P.prototype={StopPropagation:E,ADD:1,REM:2,MOD:4,ADD_REM:3,ADD_MOD:5,ALL:7,REFLOW:8,SOURCE:16,NO_SOURCE:32,NO_FIELDS:64,fork(t){return new P(this.dataflow).init(this,t)},clone(){const t=this.fork(7);return t.add=t.add.slice(),t.rem=t.rem.slice(),t.mod=t.mod.slice(),t.source&&(t.source=t.source.slice()),t.materialize(23)},addAll(){let t=this;return!t.source||t.add===t.rem||!t.rem.length&&t.source.length===t.add.length||(t=new P(this.dataflow).init(this),t.add=t.source,t.rem=[]),t},init(t,e){const n=this;return n.stamp=t.stamp,n.encode=t.encode,!t.fields||64&e||(n.fields=t.fields),1&e?(n.addF=t.addF,n.add=t.add):(n.addF=null,n.add=[]),2&e?(n.remF=t.remF,n.rem=t.rem):(n.remF=null,n.rem=[]),4&e?(n.modF=t.modF,n.mod=t.mod):(n.modF=null,n.mod=[]),32&e?(n.srcF=null,n.source=null):(n.srcF=t.srcF,n.source=t.source,t.cleans&&(n.cleans=t.cleans)),n},runAfter(t){this.dataflow.runAfter(t)},changed(t){const e=t||7;return 1&e&&this.add.length||2&e&&this.rem.length||4&e&&this.mod.length},reflow(t){if(t)return this.fork(7).reflow();const e=this.add.length,n=this.source&&this.source.length;return n&&n!==e&&(this.mod=this.source,e&&this.filter(4,q(this,1))),this},clean(t){return arguments.length?(this.cleans=!!t,this):this.cleans},modifies(t){const n=this.fields||(this.fields={});return e.isArray(t)?t.forEach(t=>n[t]=!0):n[t]=!0,this},modified(t,n){const r=this.fields;return!(!n&&!this.mod.length||!r)&&(arguments.length?e.isArray(t)?t.some(t=>r[t]):r[t]:!!r)},filter(t,e){const n=this;return 1&t&&(n.addF=O(n.addF,e)),2&t&&(n.remF=O(n.remF,e)),4&t&&(n.modF=O(n.modF,e)),16&t&&(n.srcF=O(n.srcF,e)),n},materialize(t){const e=this;return 1&(t=t||7)&&e.addF&&(e.add=b(e.add,e.addF),e.addF=null),2&t&&e.remF&&(e.rem=b(e.rem,e.remF),e.remF=null),4&t&&e.modF&&(e.mod=b(e.mod,e.modF),e.modF=null),16&t&&e.srcF&&(e.source=e.source.filter(e.srcF),e.srcF=null),e},visit(t,n){let r,s,i=this,o=n;return 16&t?(e.visitArray(i.source,i.srcF,o),i):(1&t&&e.visitArray(i.add,i.addF,o),2&t&&e.visitArray(i.rem,i.remF,o),4&t&&e.visitArray(i.mod,i.modF,o),8&t&&(r=i.source)&&(s=i.add.length+i.mod.length,s===r.length||(s?e.visitArray(r,q(i,5),o):e.visitArray(r,i.srcF,o))),i)}},e.inherits(M,P,{fork(t){const e=new P(this.dataflow).init(this,t&this.NO_FIELDS);return void 0!==t&&(t&e.ADD&&this.visit(e.ADD,t=>e.add.push(t)),t&e.REM&&this.visit(e.REM,t=>e.rem.push(t)),t&e.MOD&&this.visit(e.MOD,t=>e.mod.push(t))),e},changed(t){return this.changes&t},modified(t){const n=this,r=n.fields;return r&&n.changes&n.MOD?e.isArray(t)?t.some((function(t){return r[t]})):r[t]:0},filter(){e.error("MultiPulse does not support filtering.")},materialize(){e.error("MultiPulse does not support materialization.")},visit(t,e){let n=this,r=n.pulses,s=r.length,i=0;if(t&n.SOURCE)for(;i<s;++i)r[i].visit(t,e);else for(;i<s;++i)r[i].stamp===n.stamp&&r[i].visit(t,e);return n}});const L={skip:!1,force:!1};function R(t){let e=[];return{clear:()=>e=[],size:()=>e.length,peek:()=>e[0],push:n=>(e.push(n),x(e,0,e.length-1,t)),pop:()=>{let n,r=e.pop();return e.length?(n=e[0],e[0]=r,function(t,e,n){let r,s=e,i=t.length,o=t[e],a=1+(e<<1);for(;a<i;)r=a+1,r<i&&n(t[a],t[r])>=0&&(a=r),t[e]=t[a],a=1+((e=a)<<1);t[e]=o,x(t,s,e,n)}(e,0,t)):n=r,n}}}function x(t,e,n,r){let s,i,o;for(s=t[n];n>e&&(o=n-1>>1,i=t[o],r(s,i)<0);)t[n]=i,n=o;return t[n]=s}function C(){this.logger(e.logger()),this.logLevel(e.Error),this._clock=0,this._rank=0,this._locale=r.defaultLocale();try{this._loader=n.loader()}catch(t){}this._touched=s(e.id),this._input={},this._pulse=null,this._heap=R((t,e)=>t.qrank-e.qrank),this._postrun=[]}function z(t){return function(){return this._log[t].apply(this,arguments)}}function T(t,e){_.call(this,t,null,e)}C.prototype={stamp(){return this._clock},loader(t){return arguments.length?(this._loader=t,this):this._loader},locale(t){return arguments.length?(this._locale=t,this):this._locale},logger(t){return arguments.length?(this._log=t,this):this._log},error:z("error"),warn:z("warn"),info:z("info"),debug:z("debug"),logLevel:z("level"),cleanThreshold:1e4,add:function(t,n,r,s){let i,o=1;return t instanceof _?i=t:t&&t.prototype instanceof _?i=new t:e.isFunction(t)?i=new _(null,t):(o=0,i=new _(t,n)),this.rank(i),o&&(s=r,r=n),r&&this.connect(i,i.parameters(r,s)),this.touch(i),i},connect:function(t,e){let n,r,s=t.rank;for(n=0,r=e.length;n<r;++n)if(s<e[n].rank)return void this.rerank(t)},rank:function(t){t.rank=++this._rank},rerank:function(t){let n,r,s,i=[t];for(;i.length;)if(this.rank(n=i.pop()),r=n._targets)for(s=r.length;--s>=0;)i.push(n=r[s]),n===t&&e.error("Cycle detected in dataflow graph.")},pulse:function(t,e,n){this.touch(t,n||L);const r=new P(this,this._clock+(this._pulse?0:1)),s=t.pulse&&t.pulse.source||[];return r.target=t,this._input[t.id]=e.pulse(r,s),this},touch:function(t,e){const n=e||L;return this._pulse?this._enqueue(t):this._touched.add(t),n.skip&&t.skip(!0),this},update:function(t,e,n){const r=n||L;return(t.set(e)||r.force)&&this.touch(t,r),this},changeset:f,ingest:function(t,e,n){return e=this.parse(e,n),this.pulse(t,this.changeset().insert(e))},parse:function(t,e){const r=this.locale();return n.read(t,e,r.timeParse,r.utcParse)},preload:async function(t,n,r){const s=this,i=s._pending||function(t){let e,n=new Promise(t=>e=t);return n.requests=0,n.done=()=>{0==--n.requests&&(t._pending=null,e(t))},t._pending=n}(s);i.requests+=1;const o=await s.request(n,r);return s.pulse(t,s.changeset().remove(e.truthy).insert(o.data||[])),i.done(),o},request:async function(t,e){const r=this;let s,i=0;try{s=await r.loader().load(t,{context:"dataflow",response:n.responseType(e&&e.type)});try{s=r.parse(s,e)}catch(e){i=-2,r.warn("Data ingestion failed",t,e)}}catch(e){i=-1,r.warn("Loading failed",t,e)}return{data:s,status:i}},events:function(t,n,r,s){let i,o=this,a=w(r,s),u=function(t){t.dataflow=o;try{a.receive(t)}catch(t){o.error(t)}finally{o.run()}};i="string"==typeof t&&"undefined"!=typeof document?document.querySelectorAll(t):e.array(t);for(let t=0,e=i.length;t<e;++t)i[t].addEventListener(n,u);return a},on:function(t,e,n,r,s){return(t instanceof _?D:A)(this,t,e,n,r,s),this},evaluate:async function(t,n,r){const o=this,a=[];if(o._pulse)return S(o);if(o._pending&&await o._pending,n&&await i(o,n),!o._touched.length)return o.debug("Dataflow invoked, but nothing to do."),o;const u=++o._clock;o._pulse=new P(o,u,t),o._touched.forEach(t=>o._enqueue(t,!0)),o._touched=s(e.id);let l,h,c,d=0;try{for(;o._heap.size()>0;)l=o._heap.pop(),l.rank===l.qrank?(h=l.run(o._getPulse(l,t)),h.then?h=await h:h.async&&(a.push(h.async),h=E),h!==E&&l._targets&&l._targets.forEach(t=>o._enqueue(t)),++d):o._enqueue(l,!0)}catch(t){o._heap.clear(),c=t}if(o._input={},o._pulse=null,o.debug(`Pulse ${u}: ${d} operators`),c&&(o._postrun=[],o.error(c)),o._postrun.length){const t=o._postrun.sort((t,e)=>e.priority-t.priority);o._postrun=[];for(let e=0;e<t.length;++e)await i(o,t[e].callback)}return r&&await i(o,r),a.length&&Promise.all(a).then(t=>o.runAsync(null,()=>{t.forEach(t=>{try{t(o)}catch(t){o.error(t)}})})),o},run:function(t,e,n){return this._pulse?S(this):(this.evaluate(t,e,n),this)},runAsync:async function(t,e,n){for(;this._running;)await this._running;const r=()=>this._running=null;return(this._running=this.evaluate(t,e,n)).then(r,r),this._running},runAfter:function(t,e,n){if(this._pulse||e)this._postrun.push({priority:n||0,callback:t});else try{t(this)}catch(t){this.error(t)}},_enqueue:function(t,e){const n=t.stamp<this._clock;n&&(t.stamp=this._clock),(n||e)&&(t.qrank=t.rank,this._heap.push(t))},_getPulse:function(t,n){const r=t.source,s=this._clock;return r&&e.isArray(r)?new M(this,s,r.map(t=>t.pulse),n):this._input[t.id]||function(t,e){if(e&&e.stamp===t.stamp)return e;t=t.fork(),e&&e!==E&&(t.source=e.source);return t}(this._pulse,r&&r.pulse)}},e.inherits(T,_,{run(t){if(t.stamp<this.stamp)return t.StopPropagation;let e;return this.skip()?this.skip(!1):e=this.evaluate(t),e=e||t,e.then?e=e.then(t=>this.pulse=t):e!==t.StopPropagation&&(this.pulse=e),e},evaluate(t){const e=this.marshall(t.stamp),n=this.transform(e,t);return e.clear(),n},transform(){}});const U={};function j(t){return t=t&&t.toLowerCase(),e.hasOwnProperty(U,t)?U[t]:null}t.Dataflow=C,t.EventStream=k,t.MultiPulse=M,t.Operator=_,t.Parameters=p,t.Pulse=P,t.Transform=T,t.UniqueList=s,t.asyncCallback=i,t.changeset=f,t.definition=function(t){const e=j(t);return e&&e.Definition||null},t.derive=function(t){return c(t,h({}))},t.ingest=h,t.isChangeSet=d,t.isTuple=function(t){return!(!t||!u(t))},t.rederive=c,t.replace=function(t,e){return l(e,u(t))},t.stableCompare=function(t,e){return t?e?(n,r)=>t(n,r)||u(e(n))-u(e(r)):(e,n)=>t(e,n)||u(e)-u(n):null},t.transform=j,t.transforms=U,t.tupleid=u,Object.defineProperty(t,"__esModule",{value:!0})}));