!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("vega-util"),require("d3-dsv"),require("topojson-client"),require("vega-format")):"function"==typeof define&&define.amd?define(["exports","vega-util","d3-dsv","topojson-client","vega-format"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).vega={},e.vega,e.d3,e.topojson,e.vega)}(this,(function(e,t,r,n,o){"use strict";const s=/^([A-Za-z]+:)?\/\//,i=/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|cid|xmpp|file|data):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i,a=/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205f\u3000]/g;async function u(e,t){const r=await this.sanitize(e,t),n=r.href;return r.localFile?this.file(n):this.http(n,t)}async function f(e,r){r=t.extend({},this.options,r);const n=this.fileAccess,o={href:null};let u,f,l;const c=i.test(e.replace(a,""));null!=e&&"string"==typeof e&&c||t.error("Sanitize failure, invalid URI: "+t.stringValue(e));const p=s.test(e);return(l=r.baseURL)&&!p&&(e.startsWith("/")||"/"===l[l.length-1]||(e="/"+e),e=l+e),f=(u=e.startsWith("file://"))||"file"===r.mode||"http"!==r.mode&&!p&&n,u?e=e.slice("file://".length):e.startsWith("//")&&("file"===r.defaultProtocol?(e=e.slice(2),f=!0):e=(r.defaultProtocol||"http")+":"+e),Object.defineProperty(o,"localFile",{value:!!f}),o.href=e,r.target&&(o.target=r.target+""),r.rel&&(o.rel=r.rel+""),"image"===r.context&&r.crossOrigin&&(o.crossOrigin=r.crossOrigin+""),o}function l(e){return e?t=>new Promise((r,n)=>{e.readFile(t,(e,t)=>{e?n(e):r(t)})}):c}async function c(){t.error("No file system access.")}function p(e){return e?async function(r,n){const o=t.extend({},this.options.http,n),s=n&&n.response,i=await e(r,o);return i.ok?t.isFunction(i[s])?i[s]():i.text():t.error(i.status+""+i.statusText)}:d}async function d(){t.error("No HTTP fetch method available.")}const h=e=>!(Number.isNaN(+e)||e instanceof Date),g={boolean:t.toBoolean,integer:t.toNumber,number:t.toNumber,date:t.toDate,string:t.toString,unknown:t.identity},m=[e=>"true"===e||"false"===e||!0===e||!1===e,e=>h(e)&&Number.isInteger(+e),h,e=>!Number.isNaN(Date.parse(e))],y=["boolean","integer","number","date"];function b(e,t){if(!e||!e.length)return"unknown";const r=e.length,n=m.length,o=m.map((e,t)=>t+1);for(let i,a,u=0,f=0;u<r;++u)for(a=t?e[u][t]:e[u],i=0;i<n;++i)if(o[i]&&(null!=(s=a)&&s==s)&&!m[i](a)&&(o[i]=0,++f,f===m.length))return"string";var s;return y[o.reduce((e,t)=>0===e?t:e,0)-1]}function v(e,t){return t.reduce((function(t,r){return t[r]=b(e,r),t}),{})}function j(e){const r=function(r,n){const o={delimiter:e};return N(r,n?t.extend(n,o):o)};return r.responseType="text",r}function N(e,n){return n.header&&(e=n.header.map(t.stringValue).join(n.delimiter)+"\n"+e),r.dsvFormat(n.delimiter).parse(e+"")}function O(e,r){const n=r&&r.property?t.field(r.property):t.identity;return!t.isObject(e)||(o=e,"function"==typeof Buffer&&t.isFunction(Buffer.isBuffer)&&Buffer.isBuffer(o))?n(JSON.parse(e)):function(e,t){return t&&t.copy?JSON.parse(JSON.stringify(e)):e}(n(e));var o}N.responseType="text",O.responseType="json";const T={interior:(e,t)=>e!==t,exterior:(e,t)=>e===t};function x(e,r){let o,s,i,a;return e=O(e,r),r&&r.feature?(o=n.feature,i=r.feature):r&&r.mesh?(o=n.mesh,i=r.mesh,a=T[r.filter]):t.error("Missing TopoJSON feature or mesh parameter."),s=(s=e.objects[i])?o(e,s,a):t.error("Invalid TopoJSON object: "+i),s&&s.features||[s]}x.responseType="json";const P={dsv:N,csv:j(","),tsv:j("\t"),json:O,topojson:x};function w(e,r){return arguments.length>1?(P[e]=r,this):t.hasOwnProperty(P,e)?P[e]:null}var z=function(e,t){return r=>({options:r||{},sanitize:f,load:u,fileAccess:!!t,file:l(t),http:p(e)})}("undefined"!=typeof fetch&&fetch,null);e.format=P,e.formats=w,e.inferType=b,e.inferTypes=v,e.loader=z,e.read=function(e,r,n,s){const i=w((r=r||{}).type||"json");return i||t.error("Unknown data format type: "+r.type),e=i(e,r),r.parse&&function(e,t,r,n){if(!e.length)return;const s=o.timeFormatDefaultLocale();r=r||s.timeParse,n=n||s.utcParse;let i,a,u,f,l,c,p,d=e.columns||Object.keys(e[0]);"auto"===t&&(t=v(e,d));for(d=Object.keys(t),i=d.map(e=>{let o,s,i=t[e];if(i&&(i.startsWith("date:")||i.startsWith("utc:"))){o=i.split(/:(.+)?/,2),s=o[1],("'"===s[0]&&"'"===s[s.length-1]||'"'===s[0]&&'"'===s[s.length-1])&&(s=s.slice(1,-1));return("utc"===o[0]?n:r)(s)}if(!g[i])throw Error("Illegal format pattern: "+e+":"+i);return g[i]}),f=0,c=e.length,p=d.length;f<c;++f)for(a=e[f],l=0;l<p;++l)u=d[l],a[u]=i[l](a[u])}(e,r.parse,n,s),t.hasOwnProperty(e,"columns")&&delete e.columns,e},e.responseType=function(e){const t=w(e);return t&&t.responseType||"text"},e.typeParsers=g,Object.defineProperty(e,"__esModule",{value:!0})}));