!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("vega-util"),require("vega-dataflow"),require("vega-statistics"),require("d3-array"),require("vega-time")):"function"==typeof define&&define.amd?define(["exports","vega-util","vega-dataflow","vega-statistics","d3-array","vega-time"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self).vega=e.vega||{},e.vega.transforms={}),e.vega,e.vega,e.vega,e.d3,e.vega)}(this,(function(e,t,i,n,a,r){"use strict";function s(e){return e&&e.length?1===e.length?e[0]:(t=e,e=>{let i=t.length,n=1,a=String(t[0](e));for(;n<i;++n)a+="|"+t[n](e);return a}):function(){return""};var t}function l(e,t,i){return i||e+(t?"_"+t:"")}const o=()=>{},u={init:o,add:o,rem:o,idx:0},d={values:{init:e=>e.cell.store=!0,value:e=>e.cell.data.values(),idx:-1},count:{value:e=>e.cell.num},__count__:{value:e=>e.missing+e.valid},missing:{value:e=>e.missing},valid:{value:e=>e.valid},sum:{init:e=>e.sum=0,value:e=>e.sum,add:(e,t)=>e.sum+=+t,rem:(e,t)=>e.sum-=t},product:{init:e=>e.product=1,value:e=>e.valid?e.product:void 0,add:(e,t)=>e.product*=t,rem:(e,t)=>e.product/=t},mean:{init:e=>e.mean=0,value:e=>e.valid?e.mean:void 0,add:(e,t)=>(e.mean_d=t-e.mean,e.mean+=e.mean_d/e.valid),rem:(e,t)=>(e.mean_d=t-e.mean,e.mean-=e.valid?e.mean_d/e.valid:e.mean)},average:{value:e=>e.valid?e.mean:void 0,req:["mean"],idx:1},variance:{init:e=>e.dev=0,value:e=>e.valid>1?e.dev/(e.valid-1):void 0,add:(e,t)=>e.dev+=e.mean_d*(t-e.mean),rem:(e,t)=>e.dev-=e.mean_d*(t-e.mean),req:["mean"],idx:1},variancep:{value:e=>e.valid>1?e.dev/e.valid:void 0,req:["variance"],idx:2},stdev:{value:e=>e.valid>1?Math.sqrt(e.dev/(e.valid-1)):void 0,req:["variance"],idx:2},stdevp:{value:e=>e.valid>1?Math.sqrt(e.dev/e.valid):void 0,req:["variance"],idx:2},stderr:{value:e=>e.valid>1?Math.sqrt(e.dev/(e.valid*(e.valid-1))):void 0,req:["variance"],idx:2},distinct:{value:e=>e.cell.data.distinct(e.get),req:["values"],idx:3},ci0:{value:e=>e.cell.data.ci0(e.get),req:["values"],idx:3},ci1:{value:e=>e.cell.data.ci1(e.get),req:["values"],idx:3},median:{value:e=>e.cell.data.q2(e.get),req:["values"],idx:3},q1:{value:e=>e.cell.data.q1(e.get),req:["values"],idx:3},q3:{value:e=>e.cell.data.q3(e.get),req:["values"],idx:3},min:{init:e=>e.min=void 0,value:e=>e.min=Number.isNaN(e.min)?e.cell.data.min(e.get):e.min,add:(e,t)=>{(t<e.min||void 0===e.min)&&(e.min=t)},rem:(e,t)=>{t<=e.min&&(e.min=NaN)},req:["values"],idx:4},max:{init:e=>e.max=void 0,value:e=>e.max=Number.isNaN(e.max)?e.cell.data.max(e.get):e.max,add:(e,t)=>{(t>e.max||void 0===e.max)&&(e.max=t)},rem:(e,t)=>{t>=e.max&&(e.max=NaN)},req:["values"],idx:4},argmin:{init:e=>e.argmin=void 0,value:e=>e.argmin||e.cell.data.argmin(e.get),add:(e,t,i)=>{t<e.min&&(e.argmin=i)},rem:(e,t)=>{t<=e.min&&(e.argmin=void 0)},req:["min","values"],idx:3},argmax:{init:e=>e.argmax=void 0,value:e=>e.argmax||e.cell.data.argmax(e.get),add:(e,t,i)=>{t>e.max&&(e.argmax=i)},rem:(e,t)=>{t>=e.max&&(e.argmax=void 0)},req:["max","values"],idx:3}},m=Object.keys(d);function f(e,t){return d[e](t)}function c(e,t){return e.idx-t.idx}function h(){this.valid=0,this.missing=0,this._ops.forEach(e=>e.init(this))}function p(e,t){null!=e&&""!==e?e==e&&(++this.valid,this._ops.forEach(i=>i.add(this,e,t))):++this.missing}function v(e,t){null!=e&&""!==e?e==e&&(--this.valid,this._ops.forEach(i=>i.rem(this,e,t))):--this.missing}function g(e){return this._out.forEach(t=>e[t.out]=t.value(this)),e}function y(e,i){const n=i||t.identity,a=function(e){const t={};e.forEach(e=>t[e.name]=e);const i=e=>{e.req&&e.req.forEach(e=>{t[e]||i(t[e]=d[e]())})};return e.forEach(i),Object.values(t).sort(c)}(e),r=e.slice().sort(c);function s(e){this._ops=a,this._out=r,this.cell=e,this.init()}return s.prototype.init=h,s.prototype.add=p,s.prototype.rem=v,s.prototype.set=g,s.prototype.get=n,s.fields=e.map(e=>e.out),s}function _(e){this._key=e?t.field(e):i.tupleid,this.reset()}m.forEach(e=>{d[e]=function(e,i){return n=>t.extend({name:e,out:n||e},u,i)}(e,d[e])});const x=_.prototype;function b(e){i.Transform.call(this,null,e),this._adds=[],this._mods=[],this._alen=0,this._mlen=0,this._drop=!0,this._cross=!1,this._dims=[],this._dnames=[],this._measures=[],this._countOnly=!1,this._counts=null,this._prev=null,this._inputs=null,this._outputs=null}x.reset=function(){this._add=[],this._rem=[],this._ext=null,this._get=null,this._q=null},x.add=function(e){this._add.push(e)},x.rem=function(e){this._rem.push(e)},x.values=function(){if(this._get=null,0===this._rem.length)return this._add;let e,t,i,n=this._add,a=this._rem,r=this._key,s=n.length,l=a.length,o=Array(s-l),u={};for(e=0;e<l;++e)u[r(a[e])]=1;for(e=0,t=0;e<s;++e)u[r(i=n[e])]?u[r(i)]=0:o[t++]=i;return this._rem=[],this._add=o},x.distinct=function(e){let i,n=this.values(),a=n.length,r={},s=0;for(;--a>=0;)i=e(n[a])+"",t.hasOwnProperty(r,i)||(r[i]=1,++s);return s},x.extent=function(e){if(this._get!==e||!this._ext){const i=this.values(),n=t.extentIndex(i,e);this._ext=[i[n[0]],i[n[1]]],this._get=e}return this._ext},x.argmin=function(e){return this.extent(e)[0]||{}},x.argmax=function(e){return this.extent(e)[1]||{}},x.min=function(e){const t=this.extent(e)[0];return null!=t?e(t):void 0},x.max=function(e){const t=this.extent(e)[1];return null!=t?e(t):void 0},x.quartile=function(e){return this._get===e&&this._q||(this._q=n.quartiles(this.values(),e),this._get=e),this._q},x.q1=function(e){return this.quartile(e)[0]},x.q2=function(e){return this.quartile(e)[1]},x.q3=function(e){return this.quartile(e)[2]},x.ci=function(e){return this._get===e&&this._ci||(this._ci=n.bootstrapCI(this.values(),1e3,.05,e),this._get=e),this._ci},x.ci0=function(e){return this.ci(e)[0]},x.ci1=function(e){return this.ci(e)[1]},b.Definition={type:"Aggregate",metadata:{generates:!0,changes:!0},params:[{name:"groupby",type:"field",array:!0},{name:"ops",type:"enum",array:!0,values:m},{name:"fields",type:"field",null:!0,array:!0},{name:"as",type:"string",null:!0,array:!0},{name:"drop",type:"boolean",default:!0},{name:"cross",type:"boolean",default:!1},{name:"key",type:"field"}]},t.inherits(b,i.Transform,{transform(e,t){const i=this,n=t.fork(t.NO_SOURCE|t.NO_FIELDS),a=e.modified();return i.stamp=n.stamp,i.value&&(a||t.modified(i._inputs,!0))?(i._prev=i.value,i.value=a?i.init(e):{},t.visit(t.SOURCE,e=>i.add(e))):(i.value=i.value||i.init(e),t.visit(t.REM,e=>i.rem(e)),t.visit(t.ADD,e=>i.add(e))),n.modifies(i._outputs),i._drop=!1!==e.drop,e.cross&&i._dims.length>1&&(i._drop=!1,i.cross()),t.clean()&&i._drop&&n.clean(!0).runAfter(()=>this.clean()),i.changes(n)},cross(){const e=this,t=e.value,i=e._dnames,n=i.map(()=>({})),a=i.length;function r(e){let t,r,s,l;for(t in e)for(s=e[t].tuple,r=0;r<a;++r)n[r][l=s[i[r]]]=l}r(e._prev),r(t),function r(s,l,o){const u=i[o],d=n[o++];for(const i in d){const n=s?s+"|"+i:i;l[u]=d[i],o<a?r(n,l,o):t[n]||e.cell(n,l)}}("",{},0)},init(e){const i=this._inputs=[],n=this._outputs=[],a={};function r(e){let n,r=t.array(t.accessorFields(e)),s=0,l=r.length;for(;s<l;++s)a[n=r[s]]||(a[n]=1,i.push(n))}this._dims=t.array(e.groupby),this._dnames=this._dims.map((function(e){var i=t.accessorName(e);return r(e),n.push(i),i})),this.cellkey=e.key?e.key:s(this._dims),this._countOnly=!0,this._counts=[],this._measures=[];let o,u,d,m,c,h,p=e.fields||[null],v=e.ops||["count"],g=e.as||[],_=p.length,x={};for(_!==v.length&&t.error("Unmatched number of fields and aggregate ops."),h=0;h<_;++h)o=p[h],u=v[h],null==o&&"count"!==u&&t.error("Null aggregate field specified."),m=t.accessorName(o),c=l(u,m,g[h]),n.push(c),"count"!==u?(d=x[m],d||(r(o),d=x[m]=[],d.field=o,this._measures.push(d)),"count"!==u&&(this._countOnly=!1),d.push(f(u,c))):this._counts.push(c);return this._measures=this._measures.map((function(e){return y(e,e.field)})),{}},cellkey:s(),cell(e,t){let i=this.value[e];return i?0===i.num&&this._drop&&i.stamp<this.stamp?(i.stamp=this.stamp,this._adds[this._alen++]=i):i.stamp<this.stamp&&(i.stamp=this.stamp,this._mods[this._mlen++]=i):(i=this.value[e]=this.newcell(e,t),this._adds[this._alen++]=i),i},newcell(e,t){const i={key:e,num:0,agg:null,tuple:this.newtuple(t,this._prev&&this._prev[e]),stamp:this.stamp,store:!1};if(!this._countOnly){const e=this._measures,t=e.length;i.agg=Array(t);for(let n=0;n<t;++n)i.agg[n]=new e[n](i)}return i.store&&(i.data=new _),i},newtuple(e,t){const n=this._dnames,a=this._dims,r=a.length,s={};for(let t=0;t<r;++t)s[n[t]]=a[t](e);return t?i.replace(t.tuple,s):i.ingest(s)},clean(){const e=this.value;for(const t in e)0===e[t].num&&delete e[t]},add(e){const t=this.cellkey(e),i=this.cell(t,e);if(i.num+=1,this._countOnly)return;i.store&&i.data.add(e);const n=i.agg;for(let t=0,i=n.length;t<i;++t)n[t].add(n[t].get(e),e)},rem(e){const t=this.cellkey(e),i=this.cell(t,e);if(i.num-=1,this._countOnly)return;i.store&&i.data.rem(e);const n=i.agg;for(let t=0,i=n.length;t<i;++t)n[t].rem(n[t].get(e),e)},celltuple(e){const t=e.tuple,i=this._counts;e.store&&e.data.values();for(let n=0,a=i.length;n<a;++n)t[i[n]]=e.num;if(!this._countOnly){const i=e.agg;for(let e=0,n=i.length;e<n;++e)i[e].set(t)}return t},changes(e){const t=this._adds,i=this._mods,n=this._prev,a=this._drop,r=e.add,s=e.rem,l=e.mod;let o,u,d,m;if(n)for(u in n)o=n[u],a&&!o.num||s.push(o.tuple);for(d=0,m=this._alen;d<m;++d)r.push(this.celltuple(t[d])),t[d]=null;for(d=0,m=this._mlen;d<m;++d)o=i[d],(0===o.num&&a?s:l).push(this.celltuple(o)),i[d]=null;return this._alen=this._mlen=0,this._prev=null,e}});function O(e){i.Transform.call(this,null,e)}function D(e,i,n){let a=e,r=i||[],s=n||[],l={},o=0;return{add:e=>s.push(e),remove:e=>l[a(e)]=++o,size:()=>r.length,data:(e,i)=>(o&&(r=r.filter(e=>!l[a(e)]),l={},o=0),i&&e&&r.sort(e),s.length&&(r=e?t.merge(e,r,s.sort(e)):r.concat(s),s=[]),r)}}function E(e){i.Transform.call(this,[],e)}function k(e){i.Operator.call(this,null,q,e)}function q(e){return this.value&&!e.modified()?this.value:t.compare(e.fields,e.orders)}function T(e){i.Transform.call(this,null,e)}function N(e){i.Transform.call(this,null,e)}O.Definition={type:"Bin",metadata:{modifies:!0},params:[{name:"field",type:"field",required:!0},{name:"interval",type:"boolean",default:!0},{name:"anchor",type:"number"},{name:"maxbins",type:"number",default:20},{name:"base",type:"number",default:10},{name:"divide",type:"number",array:!0,default:[5,2]},{name:"extent",type:"number",array:!0,length:2,required:!0},{name:"span",type:"number"},{name:"step",type:"number"},{name:"steps",type:"number",array:!0},{name:"minstep",type:"number",default:0},{name:"nice",type:"boolean",default:!0},{name:"name",type:"string"},{name:"as",type:"string",array:!0,length:2,default:["bin0","bin1"]}]},t.inherits(O,i.Transform,{transform(e,i){const n=!1!==e.interval,a=this._bins(e),r=a.start,s=a.step,l=e.as||["bin0","bin1"],o=l[0],u=l[1];let d;return d=e.modified()?(i=i.reflow(!0)).SOURCE:i.modified(t.accessorFields(e.field))?i.ADD_MOD:i.ADD,i.visit(d,n?e=>{const t=a(e);e[o]=t,e[u]=null==t?null:r+s*(1+(t-r)/s)}:e=>e[o]=a(e)),i.modifies(n?l:o)},_bins(e){if(this.value&&!e.modified())return this.value;let i,a,r=e.field,s=n.bin(e),l=s.step,o=s.start,u=o+Math.ceil((s.stop-o)/l)*l;null!=(i=e.anchor)&&(a=i-(o+l*Math.floor((i-o)/l)),o+=a,u+=a);const d=function(e){let i=t.toNumber(r(e));return null==i?null:i<o?-1/0:i>u?1/0:(i=Math.max(o,Math.min(i,u-l)),o+l*Math.floor(1e-14+(i-o)/l))};return d.start=o,d.stop=s.stop,d.step=l,this.value=t.accessor(d,t.accessorFields(r),e.name||"bin_"+t.accessorName(r))}}),E.Definition={type:"Collect",metadata:{source:!0},params:[{name:"sort",type:"compare"}]},t.inherits(E,i.Transform,{transform(e,t){const n=t.fork(t.ALL),a=D(i.tupleid,this.value,n.materialize(n.ADD).add),r=e.sort,s=t.changed()||r&&(e.modified("sort")||t.modified(r.fields));return n.visit(n.REM,a.remove),this.modified(s),this.value=n.source=a.data(i.stableCompare(r),s),t.source&&t.source.root&&(this.value.root=t.source.root),n}}),t.inherits(k,i.Operator),T.Definition={type:"CountPattern",metadata:{generates:!0,changes:!0},params:[{name:"field",type:"field",required:!0},{name:"case",type:"enum",values:["upper","lower","mixed"],default:"mixed"},{name:"pattern",type:"string",default:'[\\w"]+'},{name:"stopwords",type:"string",default:""},{name:"as",type:"string",array:!0,length:2,default:["text","count"]}]},t.inherits(T,i.Transform,{transform(e,t){const i=t=>i=>{for(var n,a=function(e,t,i){switch(t){case"upper":e=e.toUpperCase();break;case"lower":e=e.toLowerCase()}return e.match(i)}(l(i),e.case,r)||[],o=0,u=a.length;o<u;++o)s.test(n=a[o])||t(n)},n=this._parameterCheck(e,t),a=this._counts,r=this._match,s=this._stop,l=e.field,o=e.as||["text","count"],u=i(e=>a[e]=1+(a[e]||0)),d=i(e=>a[e]-=1);return n?t.visit(t.SOURCE,u):(t.visit(t.ADD,u),t.visit(t.REM,d)),this._finish(t,o)},_parameterCheck(e,t){let i=!1;return!e.modified("stopwords")&&this._stop||(this._stop=new RegExp("^"+(e.stopwords||"")+"$","i"),i=!0),!e.modified("pattern")&&this._match||(this._match=new RegExp(e.pattern||"[\\w']+","g"),i=!0),(e.modified("field")||t.modified(e.field.fields))&&(i=!0),i&&(this._counts={}),i},_finish(e,t){let n,a,r,s=this._counts,l=this._tuples||(this._tuples={}),o=t[0],u=t[1],d=e.fork(e.NO_SOURCE|e.NO_FIELDS);for(n in s)a=l[n],r=s[n]||0,!a&&r?(l[n]=a=i.ingest({}),a[o]=n,a[u]=r,d.add.push(a)):0===r?(a&&d.rem.push(a),s[n]=null,l[n]=null):a[u]!==r&&(a[u]=r,d.mod.push(a));return d.modifies(t)}}),N.Definition={type:"Cross",metadata:{generates:!0},params:[{name:"filter",type:"expr"},{name:"as",type:"string",array:!0,length:2,default:["a","b"]}]},t.inherits(N,i.Transform,{transform(e,n){let a=n.fork(n.NO_SOURCE),r=this.value,s=e.as||["a","b"],l=s[0],o=s[1];return!r||n.changed(n.ADD_REM)||e.modified("as")||e.modified("filter")?(r&&(a.rem=r),r=n.materialize(n.SOURCE).source,a.add=this.value=function(e,t,n,a){for(var r,s,l=[],o={},u=e.length,d=0;d<u;++d)for(o[t]=s=e[d],r=0;r<u;++r)o[n]=e[r],a(o)&&(l.push(i.ingest(o)),(o={})[t]=s);return l}(r,l,o,e.filter||t.truthy)):a.mod=r,a.source=this.value,a.modifies(s)}});const w={kde:n.randomKDE,mixture:n.randomMixture,normal:n.randomNormal,lognormal:n.randomLogNormal,uniform:n.randomUniform};function R(e){i.Transform.call(this,null,e)}var S=[{key:{function:"normal"},params:[{name:"mean",type:"number",default:0},{name:"stdev",type:"number",default:1}]},{key:{function:"lognormal"},params:[{name:"mean",type:"number",default:0},{name:"stdev",type:"number",default:1}]},{key:{function:"uniform"},params:[{name:"min",type:"number",default:0},{name:"max",type:"number",default:1}]},{key:{function:"kde"},params:[{name:"field",type:"field",required:!0},{name:"from",type:"data"},{name:"bandwidth",type:"number",default:0}]}],C={key:{function:"mixture"},params:[{name:"distributions",type:"param",array:!0,params:S},{name:"weights",type:"number",array:!0}]};function M(e,i){return e?e.map((e,n)=>i[n]||t.accessorName(e)):null}function U(e,t,i){let n,a,r,s,l,o,u=[],d=e=>e(s);if(null==t)u.push(e.map(i));else for(n={},a=0,r=e.length;a<r;++a)s=e[a],l=t.map(d),o=n[l],o||(n[l]=o=[],o.dims=l,u.push(o)),o.push(i(s));return u}R.Definition={type:"Density",metadata:{generates:!0},params:[{name:"extent",type:"number",array:!0,length:2},{name:"steps",type:"number"},{name:"minsteps",type:"number",default:25},{name:"maxsteps",type:"number",default:200},{name:"method",type:"string",default:"pdf",values:["pdf","cdf"]},{name:"distribution",type:"param",params:S.concat(C)},{name:"as",type:"string",array:!0,default:["value","density"]}]},t.inherits(R,i.Transform,{transform(e,a){const r=a.fork(a.NO_SOURCE|a.NO_FIELDS);if(!this.value||a.changed()||e.modified()){let s=function e(i,n){const a=i.function;t.hasOwnProperty(w,a)||t.error("Unknown distribution function: "+a);const r=w[a]();for(const t in i)"field"===t?r.data((i.from||n()).map(i[t])):"distributions"===t?r[t](i[t].map(t=>e(t,n))):"function"==typeof r[t]&&r[t](i[t]);return r}(e.distribution,function(e){return()=>e.materialize(e.SOURCE).source}(a)),l=e.steps||e.minsteps||25,o=e.steps||e.maxsteps||200,u=e.method||"pdf";"pdf"!==u&&"cdf"!==u&&t.error("Invalid density method: "+u),e.extent||s.data||t.error("Missing density extent parameter."),u=s[u];const d=e.as||["value","density"],m=e.extent||t.extent(s.data()),f=n.sampleCurve(u,m,l,o).map(e=>{const t={};return t[d[0]]=e[0],t[d[1]]=e[1],i.ingest(t)});this.value&&(r.rem=this.value),this.value=r.add=r.source=f}return r}});function A(e){i.Transform.call(this,null,e)}A.Definition={type:"DotBin",metadata:{modifies:!0},params:[{name:"field",type:"field",required:!0},{name:"groupby",type:"field",array:!0},{name:"step",type:"number"},{name:"smooth",type:"boolean",default:!1},{name:"as",type:"string",default:"bin"}]};function F(e){i.Operator.call(this,null,z,e),this.modified(!0)}function z(e){const i=e.expr;return this.value&&!e.modified("expr")?this.value:t.accessor(t=>i(t,e),t.accessorFields(i),t.accessorName(i))}function L(e){i.Transform.call(this,[void 0,void 0],e)}function I(e,t){i.Operator.call(this,e),this.parent=t,this.count=0}function P(e){i.Transform.call(this,{},e),this._keys=t.fastmap();const n=this._targets=[];n.active=0,n.forEach=e=>{for(let t=0,i=n.active;t<i;++t)e(n[t],t,n)}}function j(e){i.Operator.call(this,null,$,e)}function $(e){return this.value&&!e.modified()?this.value:t.isArray(e.name)?t.array(e.name).map(e=>t.field(e)):t.field(e.name,e.as)}function B(e){i.Transform.call(this,t.fastmap(),e)}function K(e){i.Transform.call(this,[],e)}function W(e){i.Transform.call(this,[],e)}function J(e){i.Transform.call(this,null,e)}function Q(e){i.Transform.call(this,[],e)}t.inherits(A,i.Transform,{transform(e,a){if(this.value&&!e.modified()&&!a.changed())return a;const r=a.materialize(a.SOURCE).source,s=U(a.source,e.groupby,t.identity),l=e.smooth||!1,o=e.field,u=e.step||((e,i)=>t.span(t.extent(e,i))/30)(r,o),d=i.stableCompare((e,t)=>o(e)-o(t)),m=e.as||"bin",f=s.length;let c,h=1/0,p=-1/0,v=0;for(;v<f;++v){const e=s[v].sort(d);c=-1;for(const t of n.dotbin(e,u,l,o))t<h&&(h=t),t>p&&(p=t),e[++c][m]=t}return this.value={start:h,stop:p,step:u},a.reflow(!0).modifies(m)}}),t.inherits(F,i.Operator),L.Definition={type:"Extent",metadata:{},params:[{name:"field",type:"field",required:!0}]},t.inherits(L,i.Transform,{transform(e,i){let n,a=this.value,r=e.field,s=a[0],l=a[1];if(n=i.changed()||i.modified(r.fields)||e.modified("field"),(n||null==s)&&(s=1/0,l=-1/0),i.visit(n?i.SOURCE:i.ADD,e=>{let i=t.toNumber(r(e));null!=i&&(i<s&&(s=i),i>l&&(l=i))}),!Number.isFinite(s)||!Number.isFinite(l)){let e=t.accessorName(r);e&&(e=` for field "${e}"`),i.dataflow.warn(`Infinite extent${e}: [${s}, ${l}]`),s=l=void 0}this.value=[s,l]}}),t.inherits(I,i.Operator,{connect(e){return this.detachSubflow=e.detachSubflow,this.targets().add(e),e.source=this},add(e){this.count+=1,this.value.add.push(e)},rem(e){this.count-=1,this.value.rem.push(e)},mod(e){this.value.mod.push(e)},init(e){this.value.init(e,e.NO_SOURCE)},evaluate(){return this.value}}),t.inherits(P,i.Transform,{activate(e){this._targets[this._targets.active++]=e},subflow(e,i,n,a){let r,s,l=this.value,o=t.hasOwnProperty(l,e)&&l[e];return o?o.value.stamp<n.stamp&&(o.init(n),this.activate(o)):(s=a||(s=this._group[e])&&s.tuple,r=n.dataflow,o=new I(n.fork(n.NO_SOURCE),this),r.add(o).connect(i(r,e,s)),l[e]=o,this.activate(o)),o},clean(){const e=this.value;for(const t in e)if(0===e[t].count){const i=e[t].detachSubflow;i&&i(),delete e[t]}},initTargets(){const e=this._targets,t=e.length;for(let i=0;i<t&&null!=e[i];++i)e[i]=null;e.active=0},transform(e,t){const n=t.dataflow,a=e.key,r=e.subflow,s=this._keys,l=e.modified("key"),o=e=>this.subflow(e,r,t);return this._group=e.group||{},this.initTargets(),t.visit(t.REM,e=>{const t=i.tupleid(e),n=s.get(t);void 0!==n&&(s.delete(t),o(n).rem(e))}),t.visit(t.ADD,e=>{const t=a(e);s.set(i.tupleid(e),t),o(t).add(e)}),l||t.modified(a.fields)?t.visit(t.MOD,e=>{const t=i.tupleid(e),n=s.get(t),r=a(e);n===r?o(r).mod(e):(s.set(t,r),o(n).rem(e),o(r).add(e))}):t.changed(t.MOD)&&t.visit(t.MOD,e=>{o(s.get(i.tupleid(e))).mod(e)}),l&&t.visit(t.REFLOW,e=>{const t=i.tupleid(e),n=s.get(t),r=a(e);n!==r&&(s.set(t,r),o(n).rem(e),o(r).add(e))}),t.clean()?n.runAfter(()=>{this.clean(),s.clean()}):s.empty>n.cleanThreshold&&n.runAfter(s.clean),t}}),t.inherits(j,i.Operator),B.Definition={type:"Filter",metadata:{changes:!0},params:[{name:"expr",type:"expr",required:!0}]},t.inherits(B,i.Transform,{transform(e,t){let n=t.dataflow,a=this.value,r=t.fork(),s=r.add,l=r.rem,o=r.mod,u=e.expr,d=!0;function m(t){const n=i.tupleid(t),r=u(t,e),m=a.get(n);r&&m?(a.delete(n),s.push(t)):r||m?d&&r&&!m&&o.push(t):(a.set(n,1),l.push(t))}return t.visit(t.REM,e=>{var t=i.tupleid(e);a.has(t)?a.delete(t):l.push(e)}),t.visit(t.ADD,t=>{u(t,e)?s.push(t):a.set(i.tupleid(t),1)}),t.visit(t.MOD,m),e.modified()&&(d=!1,t.visit(t.REFLOW,m)),a.empty>n.cleanThreshold&&n.runAfter(a.clean),r}}),K.Definition={type:"Flatten",metadata:{generates:!0},params:[{name:"fields",type:"field",array:!0,required:!0},{name:"index",type:"string"},{name:"as",type:"string",array:!0}]},t.inherits(K,i.Transform,{transform(e,t){const n=t.fork(t.NO_SOURCE),a=e.fields,r=M(a,e.as||[]),s=e.index||null,l=r.length;return n.rem=this.value,t.visit(t.SOURCE,e=>{let t,o,u,d=a.map(t=>t(e)),m=d.reduce((e,t)=>Math.max(e,t.length),0),f=0;for(;f<m;++f){for(o=i.derive(e),t=0;t<l;++t)o[r[t]]=null==(u=d[t][f])?null:u;s&&(o[s]=f),n.add.push(o)}}),this.value=n.source=n.add,s&&n.modifies(s),n.modifies(r)}}),W.Definition={type:"Fold",metadata:{generates:!0},params:[{name:"fields",type:"field",array:!0,required:!0},{name:"as",type:"string",array:!0,length:2,default:["key","value"]}]},t.inherits(W,i.Transform,{transform(e,n){const a=n.fork(n.NO_SOURCE),r=e.fields,s=r.map(t.accessorName),l=e.as||["key","value"],o=l[0],u=l[1],d=r.length;return a.rem=this.value,n.visit(n.SOURCE,e=>{for(let t,n=0;n<d;++n)t=i.derive(e),t[o]=s[n],t[u]=r[n](e),a.add.push(t)}),this.value=a.source=a.add,a.modifies(l)}}),J.Definition={type:"Formula",metadata:{modifies:!0},params:[{name:"expr",type:"expr",required:!0},{name:"as",type:"string",required:!0},{name:"initonly",type:"boolean"}]},t.inherits(J,i.Transform,{transform(e,t){const i=e.expr,n=e.as,a=e.modified(),r=e.initonly?t.ADD:a?t.SOURCE:t.modified(i.fields)||t.modified(n)?t.ADD_MOD:t.ADD;return a&&(t=t.materialize().reflow(!0)),e.initonly||t.modifies(n),t.visit(r,t=>t[n]=i(t,e))}}),t.inherits(Q,i.Transform,{transform(e,t){let n,a,r,s=this.value,l=t.fork(t.ALL),o=e.size-s.length,u=e.generator;if(o>0){for(n=[];--o>=0;)n.push(r=i.ingest(u(e))),s.push(r);l.add=l.add.length?l.materialize(l.ADD).add.concat(n):n}else a=s.slice(0,-o),l.rem=l.rem.length?l.materialize(l.REM).rem.concat(a):a,s=s.slice(-o);return l.source=this.value=s,l}});const G={value:"value",median:a.median,mean:a.mean,min:a.min,max:a.max},H=[];function V(e){i.Transform.call(this,[],e)}function X(e){b.call(this,e)}function Y(e){i.Transform.call(this,null,e)}function Z(e){i.Operator.call(this,null,ee,e)}function ee(e){return this.value&&!e.modified()?this.value:t.key(e.fields,e.flat)}function te(e){i.Transform.call(this,[],e),this._pending=null}function ie(e,t,n){n.forEach(i.ingest);const a=t.fork(t.NO_FIELDS&t.NO_SOURCE);return a.rem=e.value,e.value=a.source=a.add=n,e._pending=null,a.rem.length&&a.clean(!0),a}function ne(e){i.Transform.call(this,{},e)}function ae(e){i.Operator.call(this,null,re,e)}function re(e){if(this.value&&!e.modified())return this.value;let t,i,n,a=1/0,r=-1/0,s=e.extents;for(t=0,i=s.length;t<i;++t)n=s[t],n[0]<a&&(a=n[0]),n[1]>r&&(r=n[1]);return[a,r]}function se(e){i.Operator.call(this,null,le,e)}function le(e){return this.value&&!e.modified()?this.value:e.values.reduce((e,t)=>e.concat(t),[])}function oe(e){i.Transform.call(this,null,e)}function ue(e){b.call(this,e)}function de(e){P.call(this,e)}function me(e){i.Transform.call(this,null,e)}function fe(e){i.Transform.call(this,null,e)}function ce(e){i.Transform.call(this,null,e)}V.Definition={type:"Impute",metadata:{changes:!0},params:[{name:"field",type:"field",required:!0},{name:"key",type:"field",required:!0},{name:"keyvals",array:!0},{name:"groupby",type:"field",array:!0},{name:"method",type:"enum",default:"value",values:["value","mean","median","max","min"]},{name:"value",default:0}]},t.inherits(V,i.Transform,{transform(e,n){var a,r,s,l,o,u,d,m,f,c,h=n.fork(n.ALL),p=function(e){var i,n=e.method||G.value;if(null!=G[n])return n===G.value?(i=void 0!==e.value?e.value:0,()=>i):G[n];t.error("Unrecognized imputation method: "+n)}(e),v=function(e){var t=e.field;return e=>e?t(e):NaN}(e),g=t.accessorName(e.field),y=t.accessorName(e.key),_=(e.groupby||[]).map(t.accessorName),x=function(e,t,i,n){var a,r,s,l,o,u,d,m,f=e=>e(m),c=[],h=n?n.slice():[],p={},v={};for(h.forEach((e,t)=>p[e]=t+1),l=0,d=e.length;l<d;++l)u=i(m=e[l]),o=p[u]||(p[u]=h.push(u)),(s=v[r=(a=t?t.map(f):H)+""])||(s=v[r]=[],c.push(s),s.values=a),s[o-1]=m;return c.domain=h,c}(n.source,e.groupby,e.key,e.keyvals),b=[],O=this.value,D=x.domain.length;for(o=0,m=x.length;o<m;++o)for(s=(a=x[o]).values,r=NaN,d=0;d<D;++d)if(null==a[d]){for(l=x.domain[d],c={_impute:!0},u=0,f=s.length;u<f;++u)c[_[u]]=s[u];c[y]=l,c[g]=Number.isNaN(r)?r=p(a,v):r,b.push(i.ingest(c))}return b.length&&(h.add=h.materialize(h.ADD).add.concat(b)),O.length&&(h.rem=h.materialize(h.REM).rem.concat(O)),this.value=b,h}}),X.Definition={type:"JoinAggregate",metadata:{modifies:!0},params:[{name:"groupby",type:"field",array:!0},{name:"fields",type:"field",null:!0,array:!0},{name:"ops",type:"enum",array:!0,values:m},{name:"as",type:"string",null:!0,array:!0},{name:"key",type:"field"}]},t.inherits(X,b,{transform(e,i){let n,a=this,r=e.modified();return a.value&&(r||i.modified(a._inputs,!0))?(n=a.value=r?a.init(e):{},i.visit(i.SOURCE,e=>a.add(e))):(n=a.value=a.value||this.init(e),i.visit(i.REM,e=>a.rem(e)),i.visit(i.ADD,e=>a.add(e))),a.changes(),i.visit(i.SOURCE,e=>{t.extend(e,n[a.cellkey(e)].tuple)}),i.reflow(r).modifies(this._outputs)},changes(){let e,t,i=this._adds,n=this._mods;for(e=0,t=this._alen;e<t;++e)this.celltuple(i[e]),i[e]=null;for(e=0,t=this._mlen;e<t;++e)this.celltuple(n[e]),n[e]=null;this._alen=this._mlen=0}}),Y.Definition={type:"KDE",metadata:{generates:!0},params:[{name:"groupby",type:"field",array:!0},{name:"field",type:"field",required:!0},{name:"cumulative",type:"boolean",default:!1},{name:"counts",type:"boolean",default:!1},{name:"bandwidth",type:"number",default:0},{name:"extent",type:"number",array:!0,length:2},{name:"resolve",type:"enum",values:["shared","independent"],default:"independent"},{name:"steps",type:"number"},{name:"minsteps",type:"number",default:25},{name:"maxsteps",type:"number",default:200},{name:"as",type:"string",array:!0,default:["value","density"]}]},t.inherits(Y,i.Transform,{transform(e,a){const r=a.fork(a.NO_SOURCE|a.NO_FIELDS);if(!this.value||a.changed()||e.modified()){const s=a.materialize(a.SOURCE).source,l=U(s,e.groupby,e.field),o=(e.groupby||[]).map(t.accessorName),u=e.bandwidth,d=e.cumulative?"cdf":"pdf",m=e.as||["value","density"],f=[];let c=e.extent,h=e.steps||e.minsteps||25,p=e.steps||e.maxsteps||200;"pdf"!==d&&"cdf"!==d&&t.error("Invalid density method: "+d),"shared"===e.resolve&&(c||(c=t.extent(s,e.field)),h=p=e.steps||p),l.forEach(a=>{const r=n.randomKDE(a,u)[d],s=e.counts?a.length:1,l=c||t.extent(a);n.sampleCurve(r,l,h,p).forEach(e=>{const t={};for(let e=0;e<o.length;++e)t[o[e]]=a.dims[e];t[m[0]]=e[0],t[m[1]]=e[1]*s,f.push(i.ingest(t))})}),this.value&&(r.rem=this.value),this.value=r.add=r.source=f}return r}}),t.inherits(Z,i.Operator),t.inherits(te,i.Transform,{transform(e,i){const n=i.dataflow;if(this._pending)return ie(this,i,this._pending);if(function(e){return e.modified("async")&&!(e.modified("values")||e.modified("url")||e.modified("format"))}(e))return i.StopPropagation;if(e.values)return ie(this,i,n.parse(e.values,e.format));if(e.async){return{async:n.request(e.url,e.format).then(e=>(this._pending=t.array(e.data),e=>e.touch(this)))}}return n.request(e.url,e.format).then(e=>ie(this,i,t.array(e.data)))}}),ne.Definition={type:"Lookup",metadata:{modifies:!0},params:[{name:"index",type:"index",params:[{name:"from",type:"data",required:!0},{name:"key",type:"field",required:!0}]},{name:"values",type:"field",array:!0},{name:"fields",type:"field",array:!0,required:!0},{name:"as",type:"string",array:!0},{name:"default",default:null}]},t.inherits(ne,i.Transform,{transform(e,i){let n,a,r,s=i,l=e.as,o=e.fields,u=e.index,d=e.values,m=null==e.default?null:e.default,f=e.modified(),c=f?i.SOURCE:i.ADD,h=o.length;return d?(a=d.length,h>1&&!l&&t.error('Multi-field lookup requires explicit "as" parameter.'),l&&l.length!==h*a&&t.error('The "as" parameter has too few output field names.'),l=l||d.map(t.accessorName),n=function(e){for(var t,i,n=0,r=0;n<h;++n)if(null==(i=u.get(o[n](e))))for(t=0;t<a;++t,++r)e[l[r]]=m;else for(t=0;t<a;++t,++r)e[l[r]]=d[t](i)}):(l||t.error("Missing output field names."),n=function(e){for(var t,i=0;i<h;++i)t=u.get(o[i](e)),e[l[i]]=null==t?m:t}),f?s=i.reflow(!0):(r=o.some(e=>i.modified(e.fields)),c|=r?i.MOD:0),i.visit(c,n),s.modifies(l)}}),t.inherits(ae,i.Operator),t.inherits(se,i.Operator),t.inherits(oe,i.Transform,{transform(e,t){return this.modified(e.modified()),this.value=e,t.fork(t.NO_SOURCE|t.NO_FIELDS)}}),ue.Definition={type:"Pivot",metadata:{generates:!0,changes:!0},params:[{name:"groupby",type:"field",array:!0},{name:"field",type:"field",required:!0},{name:"value",type:"field",required:!0},{name:"op",type:"enum",values:m,default:"sum"},{name:"limit",type:"number",default:0},{name:"key",type:"field"}]},t.inherits(ue,b,{_transform:b.prototype.transform,transform(e,i){return this._transform(function(e,i){const n=e.field,a=e.value,r=("count"===e.op?"__count__":e.op)||"sum",s=t.accessorFields(n).concat(t.accessorFields(a)),l=function(e,i,n){const a={},r=[];return n.visit(n.SOURCE,t=>{const i=e(t);a[i]||(a[i]=1,r.push(i))}),r.sort(t.ascending),i?r.slice(0,i):r}(n,e.limit||0,i);i.changed()&&e.set("__pivot__",null,null,!0);return{key:e.key,groupby:e.groupby,ops:l.map((function(){return r})),fields:l.map((function(e){return function(e,i,n,a){return t.accessor(t=>i(t)===e?n(t):NaN,a,e+"")}(e,n,a,s)})),as:l.map((function(e){return e+""})),modified:e.modified.bind(e)}}(e,i),i)}}),t.inherits(de,P,{transform(e,n){const a=e.subflow,r=e.field,s=e=>this.subflow(i.tupleid(e),a,n,e);return(e.modified("field")||r&&n.modified(t.accessorFields(r)))&&t.error("PreFacet does not support field modification."),this.initTargets(),r?(n.visit(n.MOD,e=>{const t=s(e);r(e).forEach(e=>t.mod(e))}),n.visit(n.ADD,e=>{const t=s(e);r(e).forEach(e=>t.add(i.ingest(e)))}),n.visit(n.REM,e=>{const t=s(e);r(e).forEach(e=>t.rem(e))})):(n.visit(n.MOD,e=>s(e).mod(e)),n.visit(n.ADD,e=>s(e).add(e)),n.visit(n.REM,e=>s(e).rem(e))),n.clean()&&n.runAfter(()=>this.clean()),n}}),me.Definition={type:"Project",metadata:{generates:!0,changes:!0},params:[{name:"fields",type:"field",array:!0},{name:"as",type:"string",null:!0,array:!0}]},t.inherits(me,i.Transform,{transform(e,t){let n,a,r=e.fields,s=M(e.fields,e.as||[]),l=r?(e,t)=>function(e,t,i,n){for(let a=0,r=i.length;a<r;++a)t[n[a]]=i[a](e);return t}(e,t,r,s):i.rederive;return this.value?a=this.value:(t=t.addAll(),a=this.value={}),n=t.fork(t.NO_SOURCE),t.visit(t.REM,e=>{const t=i.tupleid(e);n.rem.push(a[t]),a[t]=null}),t.visit(t.ADD,e=>{const t=l(e,i.ingest({}));a[i.tupleid(e)]=t,n.add.push(t)}),t.visit(t.MOD,e=>{n.mod.push(l(e,a[i.tupleid(e)]))}),n}}),t.inherits(fe,i.Transform,{transform(e,t){return this.value=e.value,e.modified("value")?t.fork(t.NO_SOURCE|t.NO_FIELDS):t.StopPropagation}}),ce.Definition={type:"Quantile",metadata:{generates:!0,changes:!0},params:[{name:"groupby",type:"field",array:!0},{name:"field",type:"field",required:!0},{name:"probs",type:"number",array:!0},{name:"step",type:"number",default:.01},{name:"as",type:"string",array:!0,default:["prob","value"]}]};function he(e){i.Transform.call(this,null,e)}function pe(e){i.Transform.call(this,[],e),this.count=0}function ve(e){i.Transform.call(this,null,e)}function ge(e){i.Transform.call(this,null,e),this.modified(!0)}function ye(e){i.Transform.call(this,null,e)}t.inherits(ce,i.Transform,{transform(e,r){const s=r.fork(r.NO_SOURCE|r.NO_FIELDS),l=e.as||["prob","value"];if(this.value&&!e.modified()&&!r.changed())return s.source=this.value,s;const o=U(r.materialize(r.SOURCE).source,e.groupby,e.field),u=(e.groupby||[]).map(t.accessorName),d=[],m=e.step||.01,f=e.probs||a.range(m/2,1-1e-14,m),c=f.length;return o.forEach(e=>{const t=n.quantiles(e,f);for(let n=0;n<c;++n){const a={};for(let t=0;t<u.length;++t)a[u[t]]=e.dims[t];a[l[0]]=f[n],a[l[1]]=t[n],d.push(i.ingest(a))}}),this.value&&(s.rem=this.value),this.value=s.add=s.source=d,s}}),t.inherits(he,i.Transform,{transform(e,t){let n,a;return this.value?a=this.value:(n=t=t.addAll(),a=this.value={}),e.derive&&(n=t.fork(t.NO_SOURCE),t.visit(t.REM,e=>{const t=i.tupleid(e);n.rem.push(a[t]),a[t]=null}),t.visit(t.ADD,e=>{const t=i.derive(e);a[i.tupleid(e)]=t,n.add.push(t)}),t.visit(t.MOD,e=>{const t=a[i.tupleid(e)];for(const i in e)t[i]=e[i],n.modifies(i);n.mod.push(t)})),n}}),pe.Definition={type:"Sample",metadata:{},params:[{name:"size",type:"number",default:1e3}]},t.inherits(pe,i.Transform,{transform(e,t){let a=t.fork(t.NO_SOURCE),r=e.modified("size"),s=e.size,l=this.value,o=this.count,u=0,d=l.reduce((e,t)=>(e[i.tupleid(t)]=1,e),{});function m(e){let t,r;l.length<s?l.push(e):(r=~~((o+1)*n.random()),r<l.length&&r>=u&&(t=l[r],d[i.tupleid(t)]&&a.rem.push(t),l[r]=e)),++o}if(t.rem.length&&(t.visit(t.REM,e=>{const t=i.tupleid(e);d[t]&&(d[t]=-1,a.rem.push(e)),--o}),l=l.filter(e=>-1!==d[i.tupleid(e)])),(t.rem.length||r)&&l.length<s&&t.source&&(u=o=l.length,t.visit(t.SOURCE,e=>{d[i.tupleid(e)]||m(e)}),u=-1),r&&l.length>s){const e=l.length-s;for(let t=0;t<e;++t)d[i.tupleid(l[t])]=-1,a.rem.push(l[t]);l=l.slice(e)}return t.mod.length&&t.visit(t.MOD,e=>{d[i.tupleid(e)]&&a.mod.push(e)}),t.add.length&&t.visit(t.ADD,m),(t.add.length||u<0)&&(a.add=l.filter(e=>!d[i.tupleid(e)])),this.count=o,this.value=a.source=l,a}}),ve.Definition={type:"Sequence",metadata:{generates:!0,changes:!0},params:[{name:"start",type:"number",required:!0},{name:"stop",type:"number",required:!0},{name:"step",type:"number",default:1},{name:"as",type:"string",default:"data"}]},t.inherits(ve,i.Transform,{transform(e,t){if(this.value&&!e.modified())return;const n=t.materialize().fork(t.MOD),r=e.as||"data";return n.rem=this.value?t.rem.concat(this.value):t.rem,this.value=a.range(e.start,e.stop,e.step||1).map(e=>{const t={};return t[r]=e,i.ingest(t)}),n.add=t.add.concat(this.value),n}}),t.inherits(ge,i.Transform,{transform(e,t){return this.value=t.source,t.changed()?t.fork(t.NO_SOURCE|t.NO_FIELDS):t.StopPropagation}});const _e=["unit0","unit1"];function xe(e){i.Transform.call(this,t.fastmap(),e)}function be(e){i.Transform.call(this,null,e)}ye.Definition={type:"TimeUnit",metadata:{modifies:!0},params:[{name:"field",type:"field",required:!0},{name:"interval",type:"boolean",default:!0},{name:"units",type:"enum",values:r.TIME_UNITS,array:!0},{name:"step",type:"number",default:1},{name:"maxbins",type:"number",default:40},{name:"extent",type:"date",array:!0},{name:"timezone",type:"enum",default:"local",values:["local","utc"]},{name:"as",type:"string",array:!0,length:2,default:_e}]},t.inherits(ye,i.Transform,{transform(e,i){let n=e.field,a=!1!==e.interval,s="utc"===e.timezone,l=this._floor(e,i),o=(s?r.utcInterval:r.timeInterval)(l.unit).offset,u=e.as||_e,d=u[0],m=u[1],f=l.start||1/0,c=l.stop||-1/0,h=l.step,p=i.ADD;return(e.modified()||i.modified(t.accessorFields(n)))&&(p=(i=i.reflow(!0)).SOURCE,f=1/0,c=-1/0),i.visit(p,e=>{let t,i,r=n(e);null==r?(e[d]=null,a&&(e[m]=null)):(e[d]=t=i=l(r),a&&(e[m]=i=o(t,h)),t<f&&(f=t),i>c&&(c=i))}),l.start=f,l.stop=c,i.modifies(a?u:d)},_floor(e,i){const n="utc"===e.timezone;let{units:a,step:s}=e.units?{units:e.units,step:e.step||1}:r.timeBin({extent:e.extent||t.extent(i.materialize(i.SOURCE).source,e.field),maxbins:e.maxbins});a=r.timeUnits(a);const l=this.value||{},o=(n?r.utcFloor:r.timeFloor)(a,s);return o.unit=t.peek(a),o.units=a,o.step=s,o.start=l.start,o.stop=l.stop,this.value=o}}),t.inherits(xe,i.Transform,{transform(e,t){const i=t.dataflow,n=e.field,a=this.value,r=e=>a.set(n(e),e);let s=!0;return e.modified("field")||t.modified(n.fields)?(a.clear(),t.visit(t.SOURCE,r)):t.changed()?(t.visit(t.REM,e=>a.delete(n(e))),t.visit(t.ADD,r)):s=!1,this.modified(s),a.empty>i.cleanThreshold&&i.runAfter(a.clean),t.fork()}}),t.inherits(be,i.Transform,{transform(e,t){(!this.value||e.modified("field")||e.modified("sort")||t.changed()||e.sort&&t.modified(e.sort.fields))&&(this.value=(e.sort?t.source.slice().sort(i.stableCompare(e.sort)):t.source).map(e.field))}});const Oe={row_number:function(){return{next:e=>e.index+1}},rank:function(){let e;return{init:()=>e=1,next:t=>{let i=t.index,n=t.data;return i&&t.compare(n[i-1],n[i])?e=i+1:e}}},dense_rank:function(){let e;return{init:()=>e=1,next:t=>{let i=t.index,n=t.data;return i&&t.compare(n[i-1],n[i])?++e:e}}},percent_rank:function(){let e=Oe.rank(),t=e.next;return{init:e.init,next:e=>(t(e)-1)/(e.data.length-1)}},cume_dist:function(){let e;return{init:()=>e=0,next:t=>{let i=t.index,n=t.data,a=t.compare;if(e<i){for(;i+1<n.length&&!a(n[i],n[i+1]);)++i;e=i}return(1+e)/n.length}}},ntile:function(e,i){(i=+i)>0||t.error("ntile num must be greater than zero.");let n=Oe.cume_dist(),a=n.next;return{init:n.init,next:e=>Math.ceil(i*a(e))}},lag:function(e,t){return t=+t||1,{next:i=>{let n=i.index-t;return n>=0?e(i.data[n]):null}}},lead:function(e,t){return t=+t||1,{next:i=>{let n=i.index+t,a=i.data;return n<a.length?e(a[n]):null}}},first_value:function(e){return{next:t=>e(t.data[t.i0])}},last_value:function(e){return{next:t=>e(t.data[t.i1-1])}},nth_value:function(e,i){return(i=+i)>0||t.error("nth_value nth must be greater than zero."),{next:t=>{let n=t.i0+(i-1);return n<t.i1?e(t.data[n]):null}}},prev_value:function(e){let t;return{init:()=>t=null,next:i=>{let n=e(i.data[i.index]);return null!=n?t=n:t}}},next_value:function(e){let t,i;return{init:()=>(t=null,i=-1),next:n=>{let a=n.data;return n.index<=i?t:(i=function(e,t,i){for(let n=t.length;i<n;++i){if(null!=e(t[i]))return i}return-1}(e,a,n.index))<0?(i=a.length,t=null):t=e(a[i])}}}};const De=Object.keys(Oe);function Ee(e){let i=this,n=t.array(e.ops),a=t.array(e.fields),r=t.array(e.params),s=t.array(e.as),o=i.outputs=[],u=i.windows=[],d={},m={},c=!0,h=[],p=[];function v(e){t.array(t.accessorFields(e)).forEach(e=>d[e]=1)}v(e.sort),n.forEach((function(e,i){let n=a[i],d=t.accessorName(n),g=l(e,d,s[i]);if(v(n),o.push(g),t.hasOwnProperty(Oe,e))u.push(function(e,i,n,a){let r=Oe[e](i,n);return{init:r.init||t.zero,update:function(e,t){t[a]=r.next(e)}}}(e,a[i],r[i],g));else{if(null==n&&"count"!==e&&t.error("Null aggregate field specified."),"count"===e)return void h.push(g);c=!1;let i=m[d];i||(i=m[d]=[],i.field=n,p.push(i)),i.push(f(e,g))}})),(h.length||p.length)&&(i.cell=function(e,t,i){e=e.map(e=>y(e,e.field));let n={num:0,agg:null,store:!1,count:t};if(!i)for(var a=e.length,r=n.agg=Array(a),s=0;s<a;++s)r[s]=new e[s](n);if(n.store)var l=n.data=new _;return n.add=function(e){if(n.num+=1,!i){l&&l.add(e);for(let t=0;t<a;++t)r[t].add(r[t].get(e),e)}},n.rem=function(e){if(n.num-=1,!i){l&&l.rem(e);for(let t=0;t<a;++t)r[t].rem(r[t].get(e),e)}},n.set=function(e){let a,s;for(l&&l.values(),a=0,s=t.length;a<s;++a)e[t[a]]=n.num;if(!i)for(a=0,s=r.length;a<s;++a)r[a].set(e)},n.init=function(){n.num=0,l&&l.reset();for(let e=0;e<a;++e)r[e].init()},n}(p,h,c)),i.inputs=Object.keys(d)}const ke=Ee.prototype;function qe(e){i.Transform.call(this,{},e),this._mlen=0,this._mods=[]}function Te(e,i,n,r){const s=r.sort,l=s&&!r.ignorePeers,o=r.frame||[null,0],u=e.data(n),d=u.length,m=l?a.bisector(s):null,f={i0:0,i1:0,p0:0,p1:0,index:0,data:u,compare:s||t.constant(-1)};i.init();for(let e=0;e<d;++e)Ne(f,o,e,d),l&&we(f,m),i.update(f,u[e])}function Ne(e,t,i,n){e.p0=e.i0,e.p1=e.i1,e.i0=null==t[0]?0:Math.max(0,i-Math.abs(t[0])),e.i1=null==t[1]?n:Math.min(n,i+Math.abs(t[1])+1),e.index=i}function we(e,t){const i=e.i0,n=e.i1-1,a=e.compare,r=e.data,s=r.length-1;i>0&&!a(r[i],r[i-1])&&(e.i0=t.left(r,r[i])),n<s&&!a(r[n],r[n+1])&&(e.i1=t.right(r,r[n]))}ke.init=function(){this.windows.forEach(e=>e.init()),this.cell&&this.cell.init()},ke.update=function(e,t){let i,n=this.cell,a=this.windows,r=e.data,s=a&&a.length;if(n){for(i=e.p0;i<e.i0;++i)n.rem(r[i]);for(i=e.p1;i<e.i1;++i)n.add(r[i]);n.set(t)}for(i=0;i<s;++i)a[i].update(e,t)},qe.Definition={type:"Window",metadata:{modifies:!0},params:[{name:"sort",type:"compare"},{name:"groupby",type:"field",array:!0},{name:"ops",type:"enum",array:!0,values:De.concat(m)},{name:"params",type:"number",null:!0,array:!0},{name:"fields",type:"field",null:!0,array:!0},{name:"as",type:"string",null:!0,array:!0},{name:"frame",type:"number",null:!0,array:!0,length:2,default:[null,0]},{name:"ignorePeers",type:"boolean",default:!1}]},t.inherits(qe,i.Transform,{transform(e,t){this.stamp=t.stamp;const n=e.modified(),a=i.stableCompare(e.sort),r=s(e.groupby),l=e=>this.group(r(e));let o=this.state;o&&!n||(o=this.state=new Ee(e)),n||t.modified(o.inputs)?(this.value={},t.visit(t.SOURCE,e=>l(e).add(e))):(t.visit(t.REM,e=>l(e).remove(e)),t.visit(t.ADD,e=>l(e).add(e)));for(let t=0,i=this._mlen;t<i;++t)Te(this._mods[t],o,a,e);return this._mlen=0,this._mods=[],t.reflow(n).modifies(o.outputs)},group(e){let t=this,n=t.value[e];return n||(n=t.value[e]=D(i.tupleid),n.stamp=-1),n.stamp<t.stamp&&(n.stamp=t.stamp,t._mods[t._mlen++]=n),n}}),e.aggregate=b,e.bin=O,e.collect=E,e.compare=k,e.countpattern=T,e.cross=N,e.density=R,e.dotbin=A,e.expression=F,e.extent=L,e.facet=P,e.field=j,e.filter=B,e.flatten=K,e.fold=W,e.formula=J,e.generate=Q,e.impute=V,e.joinaggregate=X,e.kde=Y,e.key=Z,e.load=te,e.lookup=ne,e.multiextent=ae,e.multivalues=se,e.params=oe,e.pivot=ue,e.prefacet=de,e.project=me,e.proxy=fe,e.quantile=ce,e.relay=he,e.sample=pe,e.sequence=ve,e.sieve=ge,e.subflow=I,e.timeunit=ye,e.tupleindex=xe,e.values=be,e.window=qe,Object.defineProperty(e,"__esModule",{value:!0})}));