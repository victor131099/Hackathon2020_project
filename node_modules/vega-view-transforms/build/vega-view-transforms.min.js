!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("vega-dataflow"),require("vega-scenegraph"),require("vega-util")):"function"==typeof define&&define.amd?define(["exports","vega-dataflow","vega-scenegraph","vega-util"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self).vega=e.vega||{},e.vega.transforms={}),e.vega,e.vega,e.vega)}(this,(function(e,t,n,o){"use strict";const r="top",a="left",i="right",s="bottom",u="end",l="row";function c(e){t.Transform.call(this,null,e)}function d(e,t,n){return t(e.bounds.clear(),e,n)}o.inherits(c,t.Transform,{transform(e,t){const o=t.dataflow,r=e.mark,a=r.marktype,i=n.Marks[a],s=i.bound;let u,l=r.bounds;if(i.nested)r.items.length&&o.dirty(r.items[0]),l=d(r,s),r.items.forEach((function(e){e.bounds.clear().union(l)}));else if("group"===a||e.modified())switch(t.visit(t.MOD,e=>o.dirty(e)),l.clear(),r.items.forEach(e=>l.union(d(e,s))),r.role){case"axis":case"legend":case"title":t.reflow()}else u=t.changed(t.REM),t.visit(t.ADD,e=>{l.union(d(e,s))}),t.visit(t.MOD,e=>{u=u||l.alignsWith(e.bounds),o.dirty(e),l.union(d(e,s))}),u&&(l.clear(),r.items.forEach(e=>l.union(e.bounds)));return n.boundClip(r),t.modifies("bounds")}});function h(e){t.Transform.call(this,0,e)}function f(e){t.Transform.call(this,null,e)}function m(e){t.Transform.call(this,null,e)}h.Definition={type:"Identifier",metadata:{modifies:!0},params:[{name:"as",type:"string",required:!0}]},o.inherits(h,t.Transform,{transform(e,t){const n=(r=t.dataflow)._signals[":vega_identifier:"]||(r._signals[":vega_identifier:"]=r.add(0)),o=e.as;var r;let a=n.value;return t.visit(t.ADD,e=>e[o]=e[o]||++a),n.set(this.value=a),t}}),o.inherits(f,t.Transform,{transform(e,t){let o=this.value;o||(o=t.dataflow.scenegraph().mark(e.markdef,function(e){const t=e.groups,n=e.parent;return t&&1===t.size?t.get(Object.keys(t.object)[0]):t&&n?t.lookup(n):null}(e),e.index),o.group.context=e.context,e.context.group||(e.context.group=o.group),o.source=this.source,o.clip=e.clip,o.interactive=e.interactive,this.value=o);const r="group"===o.marktype?n.GroupItem:n.Item;return t.visit(t.ADD,e=>r.call(e,o)),(e.modified("clip")||e.modified("interactive"))&&(o.clip=e.clip,o.interactive=!!e.interactive,o.zdirty=!0,t.reflow()),o.items=t.source,t}});const b={parity:e=>e.filter((e,t)=>t%2?e.opacity=0:1),greedy:(e,t)=>{let n;return e.filter((e,o)=>o&&y(n.bounds,e.bounds,t)?e.opacity=0:(n=e,1))}},y=(e,t,n)=>n>Math.max(t.x1-e.x2,e.x1-t.x2,t.y1-e.y2,e.y1-t.y2),x=(e,t)=>{for(var n,o=1,r=e.length,a=e[0].bounds;o<r;a=n,++o)if(y(a,n=e[o].bounds,t))return!0},g=e=>{var t=e.bounds;return t.width()>1&&t.height()>1},p=e=>(e.forEach(e=>e.opacity=1),e),w=(e,t)=>e.reflow(t.modified()).modifies("opacity");function k(e){t.Transform.call(this,null,e)}o.inherits(m,t.Transform,{transform(e,t){let a,i,s,u=b[e.method]||b.parity,l=t.materialize(t.SOURCE).source,c=e.separation||0;if(l&&l.length){if(!e.method)return e.modified("method")&&(p(l),t=w(t,e)),t;if(l=l.filter(g),l.length){if(e.sort&&(l=l.slice().sort(e.sort)),a=p(l),t=w(t,e),a.length>=3&&x(a,c)){do{a=u(a,c)}while(a.length>=3&&x(a,c));a.length<3&&!o.peek(l).opacity&&(a.length>1&&(o.peek(a).opacity=0),o.peek(l).opacity=1)}var d,h,f,m,y;return e.boundScale&&e.boundTolerance>=0&&(d=e.boundScale,h=e.boundOrient,f=+e.boundTolerance,m=d.range(),y=new n.Bounds,h===r||"bottom"===h?y.set(m[0],-1/0,m[1],1/0):y.set(-1/0,m[0],1/0,m[1]),y.expand(f||1),i=e=>y.encloses(e.bounds),l.forEach(e=>{i(e)||(e.opacity=0)})),s=a[0].mark.bounds.clear(),l.forEach(e=>{e.opacity&&s.union(e.bounds)}),t}}}}),o.inherits(k,t.Transform,{transform(e,t){const n=t.dataflow;if(t.visit(t.ALL,e=>n.dirty(e)),t.fields&&t.fields.zindex){var o=t.source&&t.source[0];o&&(o.mark.zdirty=!0)}}});const M=new n.Bounds;function v(e,t,n){return e[t]===n?0:(e[t]=n,1)}function T(e){var t=e.items[0].orient;return t===a||t===i}function E(e,t,o,s){var u,l,c=t.items[0],d=c.datum,h=null!=c.translate?c.translate:.5,f=c.orient,m=function(e){var t=+e.grid;return[e.ticks?t++:-1,e.labels?t++:-1,t+ +e.domain]}(d),b=c.range,y=c.offset,x=c.position,g=c.minExtent,p=c.maxExtent,w=d.title&&c.items[m[2]].items[0],k=c.titlePadding,T=c.bounds,E=w&&n.multiLineOffset(w),A=0,z=0;switch(M.clear().union(T),T.clear(),(u=m[0])>-1&&T.union(c.items[u].bounds),(u=m[1])>-1&&T.union(c.items[u].bounds),f){case r:A=x||0,z=-y,l=Math.max(g,Math.min(p,-T.y1)),T.add(0,-l).add(b,0),w&&_(e,w,l,k,E,0,-1,T);break;case a:A=-y,z=x||0,l=Math.max(g,Math.min(p,-T.x1)),T.add(-l,0).add(0,b),w&&_(e,w,l,k,E,1,-1,T);break;case i:A=o+y,z=x||0,l=Math.max(g,Math.min(p,T.x2)),T.add(0,0).add(l,b),w&&_(e,w,l,k,E,1,1,T);break;case"bottom":A=x||0,z=s+y,l=Math.max(g,Math.min(p,T.y2)),T.add(0,0).add(b,l),w&&_(e,w,l,k,0,0,1,T);break;default:A=c.x,z=c.y}return n.boundStroke(T.translate(A,z),c),v(c,"x",A+h)|v(c,"y",z+h)&&(c.bounds=M,e.dirty(c),c.bounds=T,e.dirty(c)),c.mark.bounds.clear().union(T)}function _(e,t,n,o,r,a,i,s){const u=t.bounds;if(t.auto){const s=i*(n+r+o);let l=0,c=0;e.dirty(t),a?l=(t.x||0)-(t.x=s):c=(t.y||0)-(t.y=s),t.mark.bounds.clear().union(u.translate(-l,-c)),e.dirty(t)}s.union(u)}const A=(e,t)=>Math.floor(Math.min(e,t)),z=(e,t)=>Math.ceil(Math.max(e,t));function B(e){return(new n.Bounds).set(0,0,e.width||0,e.height||0)}function D(e){var t=e.bounds.clone();return t.empty()?t.set(0,0,0,0):t.translate(-(e.x||0),-(e.y||0))}function O(e,t,n){var r=o.isObject(e)?e[t]:e;return null!=r?r:void 0!==n?n:0}function j(e){return e<0?Math.ceil(-e):0}function q(e,t,n){var o,r,a,i,s,c,d,h,f,m,b,y=!n.nodirty,x="flush"===n.bounds?B:D,g=M.set(0,0,0,0),p=O(n.align,"column"),w=O(n.align,l),k=O(n.padding,"column"),v=O(n.padding,l),T=n.columns||t.length,E=T<=0?1:Math.ceil(t.length/T),_=t.length,A=Array(_),z=Array(T),q=0,S=Array(_),L=Array(E),I=0,P=Array(_),C=Array(_),F=Array(_);for(r=0;r<T;++r)z[r]=0;for(r=0;r<E;++r)L[r]=0;for(r=0;r<_;++r)c=t[r],s=F[r]=x(c),c.x=c.x||0,P[r]=0,c.y=c.y||0,C[r]=0,a=r%T,i=~~(r/T),q=Math.max(q,d=Math.ceil(s.x2)),I=Math.max(I,h=Math.ceil(s.y2)),z[a]=Math.max(z[a],d),L[i]=Math.max(L[i],h),A[r]=k+j(s.x1),S[r]=v+j(s.y1),y&&e.dirty(t[r]);for(r=0;r<_;++r)r%T==0&&(A[r]=0),r<T&&(S[r]=0);if("each"===p)for(a=1;a<T;++a){for(b=0,r=a;r<_;r+=T)b<A[r]&&(b=A[r]);for(r=a;r<_;r+=T)A[r]=b+z[a-1]}else if("all"===p){for(b=0,r=0;r<_;++r)r%T&&b<A[r]&&(b=A[r]);for(r=0;r<_;++r)r%T&&(A[r]=b+q)}else for(p=!1,a=1;a<T;++a)for(r=a;r<_;r+=T)A[r]+=z[a-1];if("each"===w)for(i=1;i<E;++i){for(b=0,o=(r=i*T)+T;r<o;++r)b<S[r]&&(b=S[r]);for(r=i*T;r<o;++r)S[r]=b+L[i-1]}else if("all"===w){for(b=0,r=T;r<_;++r)b<S[r]&&(b=S[r]);for(r=T;r<_;++r)S[r]=b+I}else for(w=!1,i=1;i<E;++i)for(o=(r=i*T)+T;r<o;++r)S[r]+=L[i-1];for(f=0,r=0;r<_;++r)f=A[r]+(r%T?f:0),P[r]+=f-t[r].x;for(a=0;a<T;++a)for(m=0,r=a;r<_;r+=T)m+=S[r],C[r]+=m-t[r].y;if(p&&O(n.center,"column")&&E>1)for(r=0;r<_;++r)(f=(s="all"===p?q:z[r%T])-F[r].x2-t[r].x-P[r])>0&&(P[r]+=f/2);if(w&&O(n.center,l)&&1!==T)for(r=0;r<_;++r)(m=(s="all"===w?I:L[~~(r/T)])-F[r].y2-t[r].y-C[r])>0&&(C[r]+=m/2);for(r=0;r<_;++r)g.union(F[r].translate(P[r],C[r]));switch(f=O(n.anchor,"x"),m=O(n.anchor,"y"),O(n.anchor,"column")){case u:f-=g.width();break;case"middle":f-=g.width()/2}switch(O(n.anchor,l)){case u:m-=g.height();break;case"middle":m-=g.height()/2}for(f=Math.round(f),m=Math.round(m),g.clear(),r=0;r<_;++r)t[r].mark.bounds.clear();for(r=0;r<_;++r)(c=t[r]).x+=P[r]+=f,c.y+=C[r]+=m,g.union(c.mark.bounds.union(c.bounds.translate(P[r],C[r]))),y&&e.dirty(c);return g}function S(e,t){return"x1"===t?e.x||0:"y1"===t?e.y||0:"x2"===t?(e.x||0)+(e.width||0):"y2"===t?(e.y||0)+(e.height||0):void 0}function L(e,t){return e.bounds[t]}function I(e,t,n,o,r,a,i,s,u,l,c,d,h,f){var m,b,y,x,g,p,w,k,M,v=n.length,T=0,E=0;if(!v)return T;for(m=c;m<v;m+=d)n[m]&&(T=i(T,u(n[m],l)));if(!t.length)return T;for(t.length>r&&(e.warn("Grid headers exceed limit: "+r),t=t.slice(0,r)),T+=a,b=0,x=t.length;b<x;++b)e.dirty(t[b]),t[b].mark.bounds.clear();for(m=c,b=0,x=t.length;b<x;++b,m+=d){for(g=(p=t[b]).mark.bounds,y=m;y>=0&&null==(w=n[y]);y-=h);s?(k=null==f?w.x:Math.round(w.bounds.x1+f*w.bounds.width()),M=T):(k=T,M=null==f?w.y:Math.round(w.bounds.y1+f*w.bounds.height())),g.union(p.bounds.translate(k-(p.x||0),M-(p.y||0))),p.x=k,p.y=M,e.dirty(p),E=i(E,g[l])}return E}function P(e,t,n,o,r,a){if(t){e.dirty(t);var i=n,s=n;o?i=Math.round(r.x1+a*r.width()):s=Math.round(r.y1+a*r.height()),t.bounds.translate(i-(t.x||0),s-(t.y||0)),t.mark.bounds.clear().union(t.bounds),t.x=i,t.y=s,e.dirty(t)}}function C(e,t,n,o,s,l,c){const d=function(e,t){const n=e[t]||{};return(t,o)=>null!=n[t]?n[t]:null!=e[t]?e[t]:o}(n,t),h=function(e,t){var n=-1/0;return e.forEach(e=>{null!=e.offset&&(n=Math.max(n,e.offset))}),n>-1/0?n:t}(e,d("offset",0)),f=d("anchor","start"),m=f===u?1:"middle"===f?.5:0,b={align:"each",bounds:d("bounds","flush"),columns:"vertical"===d("direction")?1:e.length,padding:d("margin",8),center:d("center"),nodirty:!0};switch(t){case a:b.anchor={x:Math.floor(o.x1)-h,column:u,y:m*(c||o.height()+2*o.y1),row:f};break;case i:b.anchor={x:Math.ceil(o.x2)+h,y:m*(c||o.height()+2*o.y1),row:f};break;case r:b.anchor={y:Math.floor(s.y1)-h,row:u,x:m*(l||s.width()+2*s.x1),column:f};break;case"bottom":b.anchor={y:Math.ceil(s.y2)+h,x:m*(l||s.width()+2*s.x1),column:f};break;case"top-left":b.anchor={x:h,y:h};break;case"top-right":b.anchor={x:l-h,y:h,column:u};break;case"bottom-left":b.anchor={x:h,y:c-h,row:u};break;case"bottom-right":b.anchor={x:l-h,y:c-h,column:u,row:u}}return b}function F(e,t){var o,r,l,c,d=t.items[0],h=d.datum,f=d.orient,m=d.bounds,b=d.x,y=d.y;return d._bounds?d._bounds.clear().union(m):d._bounds=m.clone(),m.clear(),function(e,t,n){var o=t.padding,r=o-n.x,l=o-n.y;if(t.datum.title){var c=t.items[1].items[0],d=c.anchor,h=t.titlePadding||0,f=o-c.x,m=o-c.y;switch(c.orient){case a:r+=Math.ceil(c.bounds.width())+h;break;case i:case s:break;default:l+=c.bounds.height()+h}switch((r||l)&&H(e,n,r,l),c.orient){case a:m+=G(t,n,c,d,1,1);break;case i:f+=G(t,n,c,u,0,0)+h,m+=G(t,n,c,d,1,1);break;case s:f+=G(t,n,c,d,0,0),m+=G(t,n,c,u,-1,0,1)+h;break;default:f+=G(t,n,c,d,0,0)}(f||m)&&H(e,c,f,m),(f=Math.round(c.bounds.x1-o))<0&&(H(e,n,-f,0),H(e,c,-f,0))}else(r||l)&&H(e,n,r,l)}(e,d,d.items[0].items[0]),m=function(e,t){return e.items.forEach(e=>t.union(e.bounds)),t.x1=e.padding,t.y1=e.padding,t}(d,m),o=2*d.padding,r=2*d.padding,m.empty()||(o=Math.ceil(m.width()+o),r=Math.ceil(m.height()+r)),"symbol"===h.type&&(l=d.items[0].items[0].items[0].items,c=l.reduce((e,t)=>(e[t.column]=Math.max(t.bounds.x2-t.x,e[t.column]||0),e),{}),l.forEach(e=>{e.width=c[e.column],e.height=e.bounds.y2-e.y})),"none"!==f&&(d.x=b=0,d.y=y=0),d.width=o,d.height=r,n.boundStroke(m.set(b,y,b+o,y+r),d),d.mark.bounds.clear().union(m),d}function G(e,t,o,r,a,i,s){const l="symbol"!==e.datum.type,c=o.datum.vgrad,d=(!l||!i&&c||s?t:t.items[0]).bounds[a?"y2":"x2"]-e.padding,h=c&&i?d:0,f=c&&i?0:d,m=a<=0?0:n.multiLineOffset(o);return Math.round("start"===r?h:r===u?f-m:.5*(d-m))}function H(e,t,n,o){t.x+=n,t.y+=o,t.bounds.translate(n,o),t.mark.bounds.translate(n,o),e.dirty(t)}function R(e){t.Transform.call(this,null,e)}o.inherits(R,t.Transform,{transform(e,t){const o=t.dataflow;return e.mark.items.forEach(t=>{e.layout&&function(e,t,n){var o,r,a,i,s,c,d,h=function(e){for(var t,n,o=e.items,r=o.length,a=0,i={marks:[],rowheaders:[],rowfooters:[],colheaders:[],colfooters:[],rowtitle:null,coltitle:null};a<r;++a)if(n=(t=o[a]).items,"group"===t.marktype)switch(t.role){case"axis":case"legend":case"title":break;case"row-header":i.rowheaders.push(...n);break;case"row-footer":i.rowfooters.push(...n);break;case"column-header":i.colheaders.push(...n);break;case"column-footer":i.colfooters.push(...n);break;case"row-title":i.rowtitle=n[0];break;case"column-title":i.coltitle=n[0];break;default:i.marks.push(...n)}return i}(t),f=h.marks,m="flush"===n.bounds?S:L,b=n.offset,y=n.columns||f.length,x=y<=0?1:Math.ceil(f.length/y),g=x*y;const p=q(e,f,n);p.empty()&&p.set(0,0,0,0),h.rowheaders&&(c=O(n.headerBand,l,null),o=I(e,h.rowheaders,f,0,x,-O(b,"rowHeader"),A,0,m,"x1",0,y,1,c)),h.colheaders&&(c=O(n.headerBand,"column",null),r=I(e,h.colheaders,f,0,y,-O(b,"columnHeader"),A,1,m,"y1",0,1,y,c)),h.rowfooters&&(c=O(n.footerBand,l,null),a=I(e,h.rowfooters,f,0,x,O(b,"rowFooter"),z,0,m,"x2",y-1,y,1,c)),h.colfooters&&(c=O(n.footerBand,"column",null),i=I(e,h.colfooters,f,0,y,O(b,"columnFooter"),z,1,m,"y2",g-y,1,y,c)),h.rowtitle&&(s=O(n.titleAnchor,l),d=O(b,"rowTitle"),d=s===u?a+d:o-d,c=O(n.titleBand,l,.5),P(e,h.rowtitle,d,0,p,c)),h.coltitle&&(s=O(n.titleAnchor,"column"),d=O(b,"columnTitle"),d=s===u?i+d:r-d,c=O(n.titleBand,"column",.5),P(e,h.coltitle,d,1,p,c))}(o,t,e.layout),function(e,t,o){var l,c,d,h,f,m=t.items,b=Math.max(0,t.width||0),y=Math.max(0,t.height||0),x=(new n.Bounds).set(0,0,b,y),g=x.clone(),p=x.clone(),w=[];for(h=0,f=m.length;h<f;++h)switch((c=m[h]).role){case"axis":(T(c)?g:p).union(E(e,c,b,y));break;case"title":l=c;break;case"legend":w.push(F(e,c));break;case"frame":case"scope":case"row-header":case"row-footer":case"row-title":case"column-header":case"column-footer":case"column-title":g.union(c.bounds),p.union(c.bounds);break;default:x.union(c.bounds)}if(w.length){const t={};w.forEach(e=>{"none"!==(d=e.orient||i)&&(t[d]||(t[d]=[])).push(e)});for(let n in t){const r=t[n];q(e,r,C(r,n,o.legends,g,p,b,y))}w.forEach(t=>{const n=t.bounds;if(n.equals(t._bounds)||(t.bounds=t._bounds,e.dirty(t),t.bounds=n,e.dirty(t)),o.autosize&&"fit"===o.autosize.type)switch(t.orient){case a:case i:x.add(n.x1,0).add(n.x2,0);break;case r:case s:x.add(0,n.y1).add(0,n.y2)}else x.union(n)})}x.union(g).union(p),l&&x.union(function(e,t,n,o,l){var c,d=t.items[0],h=d.frame,f=d.orient,m=d.anchor,b=d.offset,y=d.padding,x=d.items[0].items[0],g=d.items[1]&&d.items[1].items[0],p=f===a||f===i?o:n,w=0,k=0,T=0,E=0,_=0;if("group"!==h?f===a?(w=l.y2,p=l.y1):f===i?(w=l.y1,p=l.y2):(w=l.x1,p=l.x2):f===a&&(w=o,p=0),c="start"===m?w:m===u?p:(w+p)/2,g&&g.text){switch(f){case r:case s:_=x.bounds.height()+y;break;case a:E=x.bounds.width()+y;break;case i:E=-x.bounds.width()-y}M.clear().union(g.bounds),M.translate(E-(g.x||0),_-(g.y||0)),v(g,"x",E)|v(g,"y",_)&&(e.dirty(g),g.bounds.clear().union(M),g.mark.bounds.clear().union(M),e.dirty(g)),M.clear().union(g.bounds)}else M.clear();switch(M.union(x.bounds),f){case r:k=c,T=l.y1-M.height()-b;break;case a:k=l.x1-M.width()-b,T=c;break;case i:k=l.x2+M.width()+b,T=c;break;case s:k=c,T=l.y2+b;break;default:k=d.x,T=d.y}return v(d,"x",k)|v(d,"y",T)&&(M.translate(k,T),e.dirty(d),d.bounds.clear().union(M),t.bounds.clear().union(M),e.dirty(d)),d.bounds}(e,l,b,y,x));t.clip&&x.set(0,0,t.width||0,t.height||0);!function(e,t,n,o){const r=o.autosize||{},a=r.type;if(e._autosize<1||!a)return;let i=e._width,s=e._height,u=Math.max(0,t.width||0),l=Math.max(0,Math.ceil(-n.x1)),c=Math.max(0,Math.ceil(n.x2-u)),d=Math.max(0,t.height||0),h=Math.max(0,Math.ceil(-n.y1)),f=Math.max(0,Math.ceil(n.y2-d));if("padding"===r.contains){const t=e.padding();i-=t.left+t.right,s-=t.top+t.bottom}"none"===a?(l=0,h=0,u=i,d=s):"fit"===a?(u=Math.max(0,i-l-c),d=Math.max(0,s-h-f)):"fit-x"===a?(u=Math.max(0,i-l-c),s=d+h+f):"fit-y"===a?(i=u+l+c,d=Math.max(0,s-h-f)):"pad"===a&&(i=u+l+c,s=d+h+f);e._resizeView(i,s,u,d,[l,h],r.resize)}(e,t,x,o)}(o,t,e)}),(c=e.mark.group)&&"legend-entry"!==c.mark.role?t.reflow():t;var c}}),e.bound=c,e.identifier=h,e.mark=f,e.overlap=m,e.render=k,e.viewlayout=R,Object.defineProperty(e,"__esModule",{value:!0})}));